import{r as i,aa as Te,a4 as Ce,ab as G,j as e,G as t,V as M,T as K,a2 as m,N as c,z,I as _,a5 as F,a6 as ke,a7 as X,a8 as J,Z as H,B as Z,J as Q,ac as Se,ad as ve,a9 as Pe}from"./index-fYug5RY9.js";import{B as g,d as De,a as Ne,b as Ge}from"./ArrowBack-hp_e3Lhp.js";import{c as Ke,a as k,b as Fe,d as U,e as He}from"./index.esm-DxB9Dm1u.js";import{u as Le}from"./formik.esm-CZ8CebFs.js";import{g as we,a as Be,b as Y}from"./customerService-B6jiC7Y6.js";import{M as b}from"./MenuItem-BoieQS9d.js";import{T as Ie,a as We,b as Ae,c as ee,d as $e}from"./TableRow-BYlKwEaj.js";import{T as h}from"./TableCell-D8S_yL8v.js";import{C as ne}from"./Checkbox-BqbNCbCc.js";import{P as Ee}from"./Pagination-Jly5gDAz.js";import{S as Ve,A as Oe}from"./Snackbar-BAUCtsSe.js";import{a as qe,c as Re,b as Me,D as ze}from"./DialogTitle-DfESKbom.js";import{D as _e}from"./DialogContentText-Cd7IkWVj.js";import"./request-DhSMy2hf.js";import"./LastPage-Brqnpezw.js";import"./Close-xbaa0MAg.js";function gn(){const[y,L]=i.useState("%"),[S,w]=i.useState([]),[o,T]=i.useState([]),[p,B]=i.useState(1),[ae,re]=i.useState(0),[Xe,I]=i.useState(!1),{id:j}=Te(),W=Ce();i.useState(null);const[C,d]=i.useState({open:!1,message:"",severity:"success"}),[te,A]=i.useState(!1),[v,ie]=i.useState(!1),[x,$]=i.useState(""),[f,se]=i.useState(""),[oe,P]=i.useState(!1),le=Ke({tenPhieu:k().required("Tên phiếu giảm giá là bắt buộc"),giaTri:k().required("Giá trị là bắt buộc").test("is-valid-value",(n,r)=>{if(!n)return r.createError({message:"Giá trị là bắt buộc"});const s=new g(n.replace(/\./g,""));if(y==="%"){if(!s.isGreaterThan(0))return r.createError({message:"Giá trị phải lớn hơn 0%"});if(!s.isLessThanOrEqualTo(100))return r.createError({message:"Giá trị không được vượt quá 100%"})}else if(y==="$"){if(!s.isGreaterThan(0))return r.createError({message:"Giá trị phải lớn hơn 0$"})}else return r.createError({message:"Loại phiếu không hợp lệ"});return!0}),giaTriToiDa:k().required("Giá trị tối đa là bắt buộc").test("is-big-decimal","Giá trị phải lớn hơn 0",n=>n?new g(n.replace(/\./g,"")).isGreaterThan(0):!1).test("is-less-than-or-equal-to-dieuKien","Giá trị tối đa phải nhỏ hơn hoặc bằng điều kiện",function(n){const{dieuKien:r}=this.parent;if(!n||!r)return!1;const s=new g(n.replace(/\./g,"")),u=new g(r.replace(/\./g,""));return s.isLessThanOrEqualTo(u)}),soLuong:Fe().required("Số lượng là bắt buộc").positive("Số lượng phải lớn hơn 0").integer("Số lượng phải là số nguyên"),dieuKien:k().required("Điều kiện là bắt buộc").test("is-big-decimal","Điều kiện phải lớn hơn 10",n=>n?new g(n.replace(/\./g,"")).isGreaterThan(10):!1),tuNgay:U().min(new Date,"Từ ngày phải là ngày trong tương lai").required("Từ ngày là bắt buộc"),denNgay:U().min(He("tuNgay"),"Đến ngày phải sau từ ngày").required("Đến ngày là bắt buộc")});i.useEffect(()=>{he()},[p,x,f,j]);const he=async()=>{I(!0);try{let n;x&&f==""?n=await we(p-1,x):f!==""&&x==""?n=await Be(p-1,f):f==""&&x==""&&(n=await Y(p-1)),w(n.content),re(n.totalPages)}catch(n){console.error(n)}finally{I(!1)}};i.useEffect(()=>{ce(),fe()},[j]);const ce=async()=>{try{const n=await Y(p-1);w(n.content)}catch(n){console.error(n)}},ue=n=>{const r={width:"100px",textAlign:"center"};switch(n){case 0:return e.jsx(m,{label:"Đồng",color:"default",sx:{...r,backgroundColor:"#CD853F",color:"#FFFFFF"}});case 1:return e.jsx(m,{label:"Bạc",color:"default",sx:{...r,backgroundColor:"#C0C0C0",color:"#000000"}});case 2:return e.jsx(m,{label:"Vàng",color:"default",sx:{...r,backgroundColor:"#FFD700",color:"#000000"}});case 3:return e.jsx(m,{label:"Bạch Kim",color:"default",sx:{...r,backgroundColor:"#E5E4E2",color:"#000000"}});case 4:return e.jsx(m,{label:"Kim Cương",color:"default",sx:{...r,backgroundColor:"#363636",color:"#FFFFFF"}});default:return e.jsx(m,{label:"Không xác định",color:"default",sx:{...r,backgroundColor:"#FFFFFF",color:"#000000"}})}},ge=n=>{const r=n.target.value;se(r),B(1),$("")},de=()=>{W("/phieugiamgia/danhsachphieugiamgia")};i.useEffect(()=>{console.log("Danh sách khách hàng đã chọn:",o)},[]),i.useEffect(()=>{o.length>a.values.soLuong&&(a.setFieldValue("soLuong",o.length),d({open:!0,message:`Số lượng khách hàng đã chọn (${o.length}) nhiều hơn số lượng phiếu đã nhập, số lượng phiếu đã được tự động điều chỉnh.`,severity:"info"}))},[o]);const a=Le({initialValues:{tenPhieu:"",giaTri:"",giaTriToiDa:"",soLuong:"",dieuKien:"",tuNgay:"",denNgay:"",kieu:"1"},validationSchema:le,onSubmit:async n=>{var r,s;try{if(P(!0),n.kieu==="2"&&o.length>n.soLuong){d({open:!0,message:`Số lượng khách hàng được chọn (${o.length}) nhiều hơn số lượng phiếu (${n.soLuong}). Vui lòng tăng số lượng phiếu.`,severity:"error"});return}if(n.kieu==="2"&&o.length<1){d({open:!0,message:"Vui lòng chọn khách hàng cho phiếu giảm giá.",severity:"error"});return}debugger;const u={ten:n.tenPhieu,giaTriDonToiThieu:new g(String(n.dieuKien).replace(/\./g,"")).toFixed(),ngayBatDau:O(n.tuNgay),ngayHetHan:O(n.denNgay),loaiGiamGia:y==="%"?1:2,giaTriGiamGia:new g(String(n.giaTri).replace(/\./g,"")).toFixed(),giamToiDa:new g(String(n.giaTriToiDa).replace(/\./g,"")).toFixed(),phamViApDung:n.kieu,soLuong:n.soLuong,listKhachHang:o};let N;j?(N=await G.put(`http://localhost:8080/api/coupons/update/${j}`,u),d({open:!0,message:"Phiếu giảm giá đã được cập nhật thành công!",severity:"success"})):(N=await G.post("http://localhost:8080/api/coupons/add",u),d({open:!0,message:"Phiếu giảm giá đã được tạo thành công!",severity:"success"})),setTimeout(()=>{W("/phieugiamgia/danhsachphieugiamgia")},3e3)}catch(u){const je=(((s=(r=u.response)==null?void 0:r.data)==null?void 0:s.error)||"Đã xảy ra lỗi!").split(":")[1].split(":")[0].trim();d({open:!0,message:`Lỗi: ${je}`,severity:"error"})}finally{P(!1)}}}),E=n=>{L(n)},me=n=>{T(r=>{const s=Array.isArray(r)&&r.includes(n)?r.filter(u=>u!==n):[...Array.isArray(r)?r:[],n];return console.log("Selected KhachHang within handler:",s),s})},V=n=>[{id:0,name:"Chưa áp dụng",color:"gray"},{id:1,name:"Đang áp dụng",color:"green"},{id:2,name:"Đã hết hạn",color:"red"},{id:3,name:"Đã hủy",color:"orange"}].find(s=>s.id===n)||{name:"Không xác định",color:"default"},pe=(n,r)=>{B(r)},xe=n=>{const r={year:"numeric",month:"2-digit",day:"2-digit"};return new Date(n).toLocaleDateString("vi-VN",r)};function O(n){return n?n.length===16?`${n}:00`:(n.length===19,n):""}const q=()=>{d({...C,open:!1}),P(!1)},fe=async()=>{try{const r=(await G.get(`http://localhost:8080/api/coupons/detail/${j}`)).data;a.setValues({stat:r.data.trangThai,maPhieu:r.data.ma,tenPhieu:r.data.ten,giaTri:r.data.giaTriGiamGia,giaTriToiDa:r.data.giamToiDa,soLuong:r.data.soLuong,dieuKien:r.data.giaTriDonToiThieu,tuNgay:r.data.ngayBatDau,denNgay:r.data.ngayHetHan,kieu:r.data.phamViApDung.toString()}),L(r.data.loaiGiamGia===1?"%":"$");const s=r.data.khachHangPhieuGiamGias||[];T(s)}catch(n){console.error("Error fetching coupon detail:",n)}},l=location.pathname.includes("/phieugiamgia/chitietphieugiamgia"),be=()=>{A(!0)},D=n=>{A(!1),n&&a.handleSubmit()};function R(n){return String(n||"").replace(/\D/g,"").replace(/\B(?=(\d{3})+(?!\d))/g,".")}const ye=()=>{T(v?[]:S.map(n=>n.id)),ie(!v)};return e.jsxs(t,{container:!0,spacing:2,children:[e.jsx(t,{item:!0,xs:6,children:e.jsxs(M,{style:{padding:"16px",height:"100%"},children:[l&&e.jsxs(t,{item:!0,xs:12,sx:{mb:2},children:[e.jsx(K,{variant:"h6",children:"Trạng thái phiếu:"}),e.jsx(m,{label:V(a.values.stat).name,sx:{backgroundColor:V(a.values.stat).color,color:"white",fontWeight:"bold"}})]}),e.jsxs("form",{onSubmit:a.handleSubmit,children:[e.jsx(c,{label:"Mã Phiếu Giảm Giá",name:"maPhieu",fullWidth:!0,margin:"normal",value:a.values.maPhieu,onChange:a.handleChange,error:a.touched.maPhieu&&!!a.errors.maPhieu,helperText:a.touched.maPhieu&&a.errors.maPhieu,InputProps:{readOnly:!0},InputLabelProps:{shrink:!0}}),e.jsx(c,{label:"Tên Phiếu Giảm Giá",name:"tenPhieu",fullWidth:!0,margin:"normal",InputProps:{readOnly:l},value:a.values.tenPhieu,onChange:a.handleChange,error:a.touched.tenPhieu&&!!a.errors.tenPhieu,helperText:a.touched.tenPhieu&&a.errors.tenPhieu}),e.jsxs(t,{container:!0,spacing:2,children:[e.jsx(t,{item:!0,xs:6,children:e.jsx(c,{label:"Giá trị giảm giá",name:"giaTri",fullWidth:!0,margin:"normal",value:a.values.giaTri,onChange:a.handleChange,error:a.touched.giaTri&&!!a.errors.giaTri,helperText:a.touched.giaTri&&a.errors.giaTri,InputProps:{readOnly:l,endAdornment:e.jsxs(z,{position:"end",children:[e.jsx(_,{onClick:()=>{l||E("%")},color:y==="%"?"primary":"default",children:e.jsx(De,{})}),e.jsx(_,{onClick:()=>{l||E("$")},color:y==="$"?"primary":"default",children:e.jsx(Ne,{})})]})}})}),e.jsx(t,{item:!0,xs:6,children:e.jsx(c,{label:" Giá trị giảm giá tối đa",name:"giaTriToiDa",fullWidth:!0,margin:"normal",value:R(a.values.giaTriToiDa),onChange:a.handleChange,error:a.touched.giaTriToiDa&&!!a.errors.giaTriToiDa,helperText:a.touched.giaTriToiDa&&a.errors.giaTriToiDa,InputProps:{readOnly:l,endAdornment:e.jsx(z,{position:"end",children:e.jsx(K,{sx:{color:"orange",fontWeight:"bold"},children:"₫"})})}})})]}),e.jsxs(t,{container:!0,spacing:2,children:[e.jsx(t,{item:!0,xs:6,children:e.jsx(c,{label:"Số lượng",value:a.values.soLuong,onChange:a.handleChange,variant:"outlined",fullWidth:!0,margin:"normal",name:"soLuong",helperText:a.touched.soLuong&&a.errors.soLuong?a.errors.soLuong:"",error:a.touched.soLuong&&!!a.errors.soLuong})}),e.jsx(t,{item:!0,xs:6,children:e.jsx(c,{label:"Giá trị đơn tối thiểu",name:"dieuKien",fullWidth:!0,margin:"normal",InputProps:{readOnly:l},value:R(a.values.dieuKien),onChange:a.handleChange,error:a.touched.dieuKien&&!!a.errors.dieuKien,helperText:a.touched.dieuKien&&a.errors.dieuKien})})]}),e.jsxs(t,{container:!0,spacing:2,children:[e.jsx(t,{item:!0,xs:6,children:e.jsx(c,{label:"Từ ngày",name:"tuNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:l},value:a.values.tuNgay,onChange:a.handleChange,InputLabelProps:{shrink:!0},error:a.touched.tuNgay&&!!a.errors.tuNgay,helperText:a.touched.tuNgay&&a.errors.tuNgay})}),e.jsx(t,{item:!0,xs:6,children:e.jsx(c,{label:"Đến ngày",name:"denNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:l},value:a.values.denNgay,InputLabelProps:{shrink:!0},onChange:a.handleChange,error:a.touched.denNgay&&!!a.errors.denNgay,helperText:a.touched.denNgay&&a.errors.denNgay})})]}),e.jsxs(t,{container:!0,justifyContent:"flex-start",alignItems:"center",spacing:2,children:[e.jsx(t,{item:!0,children:e.jsx(F,{component:"legend",children:"Phạm vi áp dụng"})}),e.jsx(t,{item:!0,children:e.jsxs(ke,{row:!0,"aria-label":"phạm vi áp dụng",name:"kieu",value:a.values.kieu,onChange:n=>{l||a.handleChange(n)},children:[e.jsx(X,{value:"1",control:e.jsx(J,{}),label:"Công khai"}),e.jsx(X,{value:"2",control:e.jsx(J,{}),label:"Cá nhân hóa"})]})})]}),!l&&e.jsx(H,{fullWidth:!0,variant:"contained",sx:{mt:2},onClick:be,disabled:oe,children:"Lưu"})]})]})}),e.jsx(t,{item:!0,xs:6,children:e.jsxs(M,{style:{padding:"16px",height:"100%"},children:[e.jsx(K,{variant:"h6",gutterBottom:!0,children:"Chọn khách hàng"}),e.jsx(Z,{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",mb:2,p:2,sx:{backgroundColor:"white",boxShadow:"0 4px 8px rgba(0, 0, 0, 0.1)",borderRadius:"8px",width:"100%"},children:e.jsxs(t,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(t,{item:!0,xs:5,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(F,{component:"legend",sx:{mb:1,fontWeight:"bold",fontSize:"1rem",color:"text.primary"},children:"Tìm kiếm"}),e.jsx(c,{value:x,onChange:n=>$(n.target.value),variant:"outlined",placeholder:"Nhập tên khách hàng",fullWidth:!0,InputProps:{style:{borderRadius:"8px"}}})]})}),e.jsx(Se,{orientation:"vertical",flexItem:!0,sx:{mx:2}}),e.jsx(t,{item:!0,xs:5,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(F,{component:"legend",sx:{mb:1,fontWeight:"bold",fontSize:"1rem",color:"text.primary"},children:"Hạng khách hàng"}),e.jsxs(ve,{labelId:"hang-khach-hang-label",id:"hang-khach-hang-select",value:f,onChange:ge,displayEmpty:!0,fullWidth:!0,sx:{borderRadius:"8px",backgroundColor:"white"},children:[e.jsx(b,{value:"",children:"-- Tất cả khách hàng --"}),e.jsx(b,{value:0,children:"Đồng"}),e.jsx(b,{value:1,children:"Bạc"}),e.jsx(b,{value:2,children:"Vàng"}),e.jsx(b,{value:3,children:"Bạch Kim"}),e.jsx(b,{value:4,children:"Kim Cương"})]})]})}),e.jsx(Pe,{color:"primary","aria-label":"back",sx:{position:"fixed",bottom:16,right:16},onClick:de,children:e.jsx(Ge,{})})]})}),e.jsx(Ie,{children:e.jsxs(We,{children:[e.jsx(Ae,{children:e.jsxs(ee,{children:[e.jsx(h,{padding:"checkbox",children:e.jsx(ne,{indeterminate:o.length>0&&o.length<S.length,checked:v,onChange:ye,disabled:l||a.values.kieu==="1"})}),e.jsx(h,{children:"Tên khách hàng"}),e.jsx(h,{children:"Số điện thoại"}),e.jsx(h,{children:"Ngày sinh"}),e.jsx(h,{children:"Hạng khách hàng"})]})}),e.jsx($e,{children:S.map(n=>e.jsxs(ee,{children:[e.jsx(h,{padding:"checkbox",children:e.jsx(ne,{checked:Array.isArray(o)&&o.includes(n.id),onChange:()=>me(n.id),disabled:l||a.values.kieu==="1"})}),e.jsx(h,{children:n.ten}),e.jsx(h,{children:n.sdt}),e.jsx(h,{children:xe(n.ngaySinh)}),e.jsx(h,{children:ue(n.hangKhachHang)})]},n.id))})]})}),e.jsx(Z,{display:"fixed",justifyContent:"center",alignItems:"center",marginTop:2,children:e.jsx(Ee,{count:ae,page:p,onChange:pe,color:"primary"})})]})}),e.jsx(Ve,{open:C.open,autoHideDuration:6e3,onClose:q,anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Oe,{onClose:q,severity:C.severity,sx:{width:"100%"},children:C.message})}),e.jsxs(qe,{open:te,onClose:()=>D(!1),children:[e.jsx(Re,{children:"Xác nhận"}),e.jsx(Me,{children:e.jsx(_e,{children:"Bạn có chắc chắn muốn lưu thông tin phiếu giảm giá này?"})}),e.jsxs(ze,{children:[e.jsx(H,{onClick:()=>D(!1),color:"primary",children:"Hủy"}),e.jsx(H,{onClick:()=>D(!0),color:"primary",autoFocus:!0,children:"Xác nhận"})]})]})]})}export{gn as default};

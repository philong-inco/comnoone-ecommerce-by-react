import{r as o,aa as Pe,a4 as Ne,bc as De,ab as j,j as e,G as $,V as k,N as p,z as Ge,I as U,Z as A,T as B,ac as we,J as $e,a6 as Ae,a7 as Z,a8 as Y,B as y,a9 as Be}from"./index-fYug5RY9.js";import{B as Ee,d as Le,a as Oe,b as Fe}from"./ArrowBack-hp_e3Lhp.js";import{c as We,a as I,d as ee}from"./index.esm-DxB9Dm1u.js";import{u as He}from"./formik.esm-CZ8CebFs.js";import{g as Re,b as te}from"./dotGiamGiaService-D6I0OFsK.js";import{T as ae,a as ne,b as re,c as b,d as se}from"./TableRow-BYlKwEaj.js";import{T as s}from"./TableCell-D8S_yL8v.js";import{C as ie}from"./Checkbox-BqbNCbCc.js";import{P as qe}from"./Pagination-Jly5gDAz.js";import{T as ze,a as Ke}from"./Tabs-CQt4FbLl.js";import{S as Me,A as Ve}from"./Snackbar-BAUCtsSe.js";import{a as _e,c as Xe,b as Je,D as Qe}from"./DialogTitle-DfESKbom.js";import{D as Ue}from"./DialogContentText-Cd7IkWVj.js";import"./LastPage-Brqnpezw.js";import"./KeyboardArrowRight-DhUyWrK4.js";import"./Close-xbaa0MAg.js";function xt(){const[E,L]=o.useState({}),[P,O]=o.useState([]),[d,F]=o.useState([]),[W,H]=o.useState({}),[oe,R]=o.useState(!1),[q,le]=o.useState(0),{id:x}=Pe(),z=Ne(),K=De(),[T,u]=o.useState({open:!1,message:"",severity:"success"}),[Ze,M]=o.useState(!1),[h,V]=o.useState(!1),[m,N]=o.useState("%"),[S,ce]=o.useState(1),[he,de]=o.useState(1),[D,Ye]=o.useState(5),[ue,_]=o.useState(!1);o.useEffect(()=>{X(S,D)},[S,D]),o.useEffect(()=>{K.pathname.includes("/dotgiamgia/cauhinhdotgiamgia/view")?V(!0):V(!1)},[K,x]),o.useEffect(()=>{const t=async()=>{debugger;try{const a=await Promise.all(d.map(async n=>{const i=await te(n);return{sanPhamId:n,productDetails:i.data.data}}));L(n=>{const i={...n};return a.forEach(({sanPhamId:l,productDetails:f})=>{i[l]=f}),i})}catch{u({open:!0,message:"không thể tìm được sản phẩm chi tiết",severity:"error"})}};d.length>0&&t()},[d]),o.useEffect(()=>{ye(),X(S,D)},[x]);const X=async(t,a)=>{R(!0);try{const n=await Re(t-1,a);O(n.data||[]),de(n.totalPage||1)}catch(n){console.error("Lỗi khi tải dữ liệu sản phẩm:",n),u({open:!0,message:"Lỗi khi tải dữ liệu sản phẩm",severity:"error"})}finally{R(!1)}},ge=(t,a)=>{ce(a)},pe=()=>{z("/dotgiamgia/danhsachdotgiamgia")},xe=async t=>{debugger;F(a=>{const n=a.includes(t)?a.filter(i=>i!==t):[...a,t];return E[t]||(async()=>{try{const l=(await te(t)).data.data;L(f=>({...f,[t]:l}))}catch{u({open:!0,message:"Lỗi khi tải sản phẩm chi tiết",severity:"error"})}})(),n})},me=(t,a)=>{debugger;H(n=>{const i=n[t]||[];return i.includes(a.id)?{...n,[t]:i.filter(l=>l!==a.id)}:{...n,[t]:[...i,a.id]}})},fe=(t,a)=>{le(a)};function J(t){return t?t.length===16?`${t}:00`:(t.length===19,t):""}const r=He({initialValues:{tenPhieu:"",giaTri:"",giaTriToiDa:"",tuNgay:"",denNgay:"",loaiChietKhau:"1"},validationSchema:We({tenPhieu:I().required("Tên đợt giảm giá là bắt buộc"),giaTri:I().required("Giá trị là bắt buộc").test("is-valid-value",(t,a)=>{if(!t)return a.createError({message:"Giá trị là bắt buộc"});const n=new Ee(t.replace(/\./g,""));if(m==="%"){if(!n.isGreaterThan(0))return a.createError({message:"Giá trị phải lớn hơn 0%"});if(!n.isLessThanOrEqualTo(100))return a.createError({message:"Giá trị không được vượt quá 100%"})}else if(m==="$"){if(!n.isGreaterThan(0))return a.createError({message:"Giá trị phải lớn hơn 0$"})}else return a.createError({message:"Loại phiếu không hợp lệ"});return!0}),tuNgay:ee().required("Ngày bắt đầu là bắt buộc").min(new Date,"Ngày bắt đầu phải từ hiện tại trở đi"),denNgay:ee().required("Ngày kết thúc là bắt buộc").when("tuNgay",(t,a)=>a.min(t,"Ngày kết thúc phải sau ngày bắt đầu"))}),onSubmit:async t=>{try{debugger;M(!0);const a=Object.values(W).flat(),n={ten:t.tenPhieu,moTa:t.moTa,giaTriGiam:t.giaTri,loaiChietKhau:m==="%"?1:2,thoiGianBatDau:J(t.tuNgay),thoiGianKetThuc:J(t.denNgay),listSanPhamChiTiet:a};let i;x?(i=await j.put(`http://localhost:8080/api/v1/discounts/update/${x}`,n),u({open:!0,message:"Đợt giảm giá đã được cập nhật thành công!",severity:"success"})):(i=await j.post("http://localhost:8080/api/v1/discounts/add",n),u({open:!0,message:"Đợt giảm giá đã được tạo thành công!",severity:"success"})),setTimeout(()=>{z("/dotgiamgia/danhsachdotgiamgia")},3e3)}catch(a){console.log(a),u({open:!0,message:"Đã xảy ra lỗi!",severity:"error"})}}}),G=t=>{_(!1),t&&r.handleSubmit()},Q=()=>{u({...T,open:!1}),M(!1)},je=()=>{_(!0)},ye=async()=>{try{debugger;const a=(await j.get(`http://localhost:8080/api/v1/discounts/${x}`)).data;r.setValues({stat:a.trangThai,maPhieu:a.ma,tenPhieu:a.ten,moTa:a.moTa,giaTri:a.giaTriGiam,tuNgay:a.thoiGianBatDau,denNgay:a.thoiGianKetthuc}),N(a.loaiChietKhau===1?"%":"$");const n=a.spctDotGiamGias||[],i=await Promise.all(n.map(async c=>(await j.get(`http://localhost:8080/api/san-pham-chi-tiet/get-by-productdetail-id?idProductDetail=${c}`)).data.data)),l=i.map(c=>parseInt(c.sanPhamId)).filter((c,g,ke)=>!isNaN(c)&&ke.indexOf(c)===g),f=i.reduce((c,g)=>(c[g.sanPhamId]||(c[g.sanPhamId]=[]),c[g.sanPhamId].push(g.id),c),{});F(l),H(f)}catch(t){console.error("Error fetching DGG detail:",t)}},[w,be]=o.useState("0"),Te=t=>{const a=t.target.value.toString().trim();w==="0"?v(n=>({...n,tenSanPham:a,ma:""})):w==="1"&&v(n=>({...n,ma:a,tenSanPham:""}))},Se=t=>{const a=t.target.value;be(a),a==="0"?v(n=>({...n,tenSanPham:C.ma,ma:""})):a==="1"&&v(n=>({...n,ma:C.tenSanPham,tenSanPham:""}))};o.useState(0);const Ce="http://localhost:8080/api/san-pham/find/filter-id?",[C,v]=o.useState({page:0,size:"5",tenSanPham:"",ma:"",trangThai:1});o.useEffect(()=>{ve()},[C]);const ve=async()=>{const t=Object.entries(C).filter(([i,l])=>l!=="").map(([i,l])=>`${i}=${l}`).join("&"),a=Ce+t,n=await j.get(a);O(n.data.data),setTotalElement(parseInt(n.data.totalElement))};return e.jsxs($,{container:!0,spacing:2,children:[e.jsx($,{item:!0,xs:4,children:e.jsx(k,{style:{padding:"16px",height:"100%"},children:e.jsxs("form",{onSubmit:r.handleSubmit,children:[e.jsx(p,{label:"Mã Đợt Giảm Giá",name:"maPhieu",fullWidth:!0,margin:"normal",value:r.values.maPhieu,onChange:r.handleChange,InputProps:{readOnly:!0},InputLabelProps:{shrink:!0}}),e.jsx(p,{label:"Tên Đợt Giảm Giá",name:"tenPhieu",fullWidth:!0,margin:"normal",value:r.values.tenPhieu,onChange:r.handleChange,error:r.touched.tenPhieu&&!!r.errors.tenPhieu,helperText:r.touched.tenPhieu&&r.errors.tenPhieu}),e.jsx(p,{label:"Giá trị phiếu",name:"giaTri",fullWidth:!0,margin:"normal",value:r.values.giaTri,onChange:r.handleChange,error:r.touched.giaTri&&!!r.errors.giaTri,helperText:r.touched.giaTri&&r.errors.giaTri,InputProps:{readOnly:h,endAdornment:e.jsxs(Ge,{position:"end",children:[e.jsx(U,{onClick:()=>!h&&N("%"),color:m==="%"?"primary":"default",children:e.jsx(Le,{})}),e.jsx(U,{onClick:()=>!h&&N("$"),color:m==="$"?"primary":"default",children:e.jsx(Oe,{})})]})}}),e.jsx(p,{label:"Từ ngày",name:"tuNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:h},value:r.values.tuNgay,onChange:r.handleChange,InputLabelProps:{shrink:!0},error:r.touched.tuNgay&&!!r.errors.tuNgay,helperText:r.touched.tuNgay&&r.errors.tuNgay}),e.jsx(p,{label:"Đến ngày",name:"denNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:h},value:r.values.denNgay,onChange:r.handleChange,InputLabelProps:{shrink:!0},error:r.touched.denNgay&&!!r.errors.denNgay,helperText:r.touched.denNgay&&r.errors.denNgay}),e.jsx(p,{label:"Mô tả đợt giảm giá",name:"moTa",fullWidth:!0,margin:"normal",value:r.values.moTa,InputLabelProps:{shrink:!0},onChange:r.handleChange,error:r.touched.moTa&&!!r.errors.moTa,helperText:r.touched.moTa&&r.errors.moTa,sx:{fontFamily:"Arial, sans-serif"}}),!h&&e.jsx(A,{fullWidth:!0,variant:"contained",sx:{mt:2},onClick:je,children:"Lưu"})]})})}),e.jsxs($,{item:!0,xs:8,children:[e.jsxs(k,{style:{padding:"16px",height:"100%"},children:[e.jsx(B,{variant:"h6",children:"Danh sách sản phẩm"}),e.jsx(we,{}),e.jsxs("div",{style:{display:"flex",padding:10,paddingTop:20},children:[e.jsx(p,{sx:{maxHeight:"10px"},color:"secondary",onChange:Te,id:"outlined-basic",label:"Nhập từ khóa",variant:"outlined"}),e.jsx("div",{style:{marginLeft:10,display:"flex",alignItems:"center"},children:e.jsx($e,{children:e.jsxs(Ae,{"aria-labelledby":"demo-controlled-radio-buttons-group",name:"controlled-radio-buttons-group",value:w,row:!0,onChange:Se,children:[e.jsx(Z,{value:"0",control:e.jsx(Y,{color:"secondary",size:"small"}),label:"Tên"}),e.jsx(Z,{value:"1",control:e.jsx(Y,{color:"secondary",size:"small"}),label:"Mã"})]})})})]}),oe?e.jsx(B,{children:"Đang tải dữ liệu..."}):e.jsx(ae,{component:k,style:{marginTop:"16px"},children:e.jsxs(ne,{children:[e.jsx(re,{children:e.jsxs(b,{children:[e.jsx(s,{sx:{textAlign:"center"},children:"Mã sản phẩm"}),e.jsx(s,{sx:{textAlign:"center"},children:"Tên sản phẩm"}),e.jsx(s,{sx:{textAlign:"center"},children:"Trạng Thái"}),e.jsx(s,{sx:{textAlign:"center"},children:"Chọn"})]})}),e.jsx(se,{children:P.length>0?P.map(t=>e.jsxs(b,{children:[e.jsx(s,{sx:{textAlign:"center"},children:t.ma}),e.jsx(s,{sx:{textAlign:"center"},children:t.ten}),e.jsx(s,{sx:{textAlign:"center"},children:e.jsx(y,{sx:{backgroundColor:t.trangThai===1?"#4caf50":"#f44336",color:"#ffffff",padding:"6px 12px",borderRadius:"12px",textAlign:"center",fontWeight:"bold"},children:t.trangThai===1?"Hoạt động":"Đã tắt"})}),e.jsx(s,{sx:{textAlign:"center"},children:e.jsx(ie,{checked:d.includes(t.id),onChange:()=>xe(t.id),disabled:h})})]},t.id)):e.jsx(b,{children:e.jsx(s,{colSpan:4,children:e.jsx(B,{variant:"body2",color:"textSecondary",align:"center",children:"Không có sản phẩm nào"})})})})]})}),e.jsx(y,{display:"fixed",justifyContent:"center",alignItems:"center",marginTop:2,children:e.jsx(qe,{count:he,page:S,onChange:ge,color:"primary"})})]}),e.jsxs(Be,{color:"primary","aria-label":"back",sx:{position:"fixed",bottom:16,right:16},onClick:pe,children:[e.jsx(Fe,{}),"  "]})]}),e.jsxs(y,{sx:{marginTop:4},children:[e.jsx(ze,{value:q,onChange:fe,children:d.map(t=>{const a=P.find(n=>n.id===t);return e.jsx(Ke,{label:a?`${a.ten}`:`Sản phẩm ${t}`},t)})}),d.map(t=>{var a;return q===d.indexOf(t)&&e.jsx(y,{sx:{marginTop:2},children:e.jsx(ae,{component:k,children:e.jsxs(ne,{children:[e.jsx(re,{children:e.jsxs(b,{children:[e.jsx(s,{children:"Chọn"}),e.jsx(s,{children:"Giá bán"}),e.jsx(s,{children:"Bàn phím"}),e.jsx(s,{children:"CPU"}),e.jsx(s,{children:"Hệ điều hành"}),e.jsx(s,{children:"Màn hình"}),e.jsx(s,{children:"Màu sắc"}),e.jsx(s,{children:"RAM"}),e.jsx(s,{children:"VGA"}),e.jsx(s,{children:"Webcam"}),e.jsx(s,{children:"Trạng thái"})]})}),e.jsx(se,{children:(a=E[t])==null?void 0:a.map(n=>{var i;return e.jsxs(b,{children:[e.jsx(s,{children:e.jsx(ie,{checked:((i=W[t])==null?void 0:i.includes(n.id))||!1,onChange:()=>me(t,n),disabled:h})}),e.jsx(s,{children:n.giaBan}),e.jsx(s,{children:n.banPhim}),e.jsx(s,{children:n.cpu}),e.jsx(s,{children:n.heDieuHanh}),e.jsx(s,{children:n.manHinh}),e.jsx(s,{children:n.mauSac}),e.jsx(s,{children:n.ram}),e.jsx(s,{children:n.vga}),e.jsx(s,{children:n.webcam}),e.jsxs(s,{children:[" ",e.jsx(y,{sx:{display:"inline-block",padding:"4px 8px",borderRadius:"8px",backgroundColor:n.trangThai===0?"error.light":"success.light",color:n.trangThai===0?"error.dark":"success.dark",fontWeight:"bold"},children:n.trangThai===0?"Không hoạt động":"Hoạt động"})]})]},n.id)})})]})})},t)})]}),e.jsx(Me,{open:T.open,autoHideDuration:6e3,onClose:Q,anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(Ve,{onClose:Q,severity:T.severity,sx:{width:"100%"},children:T.message})}),e.jsxs(_e,{open:ue,onClose:()=>G(!1),children:[e.jsx(Xe,{children:"Xác nhận"}),e.jsx(Je,{children:e.jsx(Ue,{children:"Bạn có chắc chắn muốn lưu thông tin phiếu giảm giá này?"})}),e.jsxs(Qe,{children:[e.jsx(A,{onClick:()=>G(!1),color:"primary",children:"Hủy"}),e.jsx(A,{onClick:()=>G(!0),color:"primary",autoFocus:!0,children:"Xác nhận"})]})]})]})}export{xt as default};

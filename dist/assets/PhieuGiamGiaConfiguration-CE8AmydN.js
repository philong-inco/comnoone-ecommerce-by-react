import{r as s,aa as Te,a4 as Ce,ab as N,j as e,G as i,V as M,T as K,a2 as m,N as g,z,I as _,a5 as F,a6 as ke,a7 as X,a8 as J,Z as H,B as Z,J as Q,ac as Se,ad as ve,a9 as Pe}from"./index-COCf9D-9.js";import{B as c,d as De,a as Ge,b as Ne}from"./ArrowBack-Dcp2cUk7.js";import{c as Ke,a as k,b as Fe,d as U,e as He}from"./index.esm-krW_ShVY.js";import{u as Le}from"./formik.esm-g0EOOUin.js";import{g as we,a as Be,b as Y}from"./customerService-BZrOvmkS.js";import{M as y}from"./MenuItem-DZ1TXfcd.js";import{T as Ie,a as We,b as $e,c as ee,d as Ae}from"./TableRow-BjFi84E7.js";import{T as u}from"./TableCell-DFzCksj9.js";import{C as ne}from"./Checkbox-BaIBsI-F.js";import{P as Ee}from"./Pagination-p0ct8pHs.js";import{S as Ve,A as qe}from"./Snackbar-DdnTY-uA.js";import{a as Oe,c as Re,b as Me,D as ze}from"./DialogTitle-C9lArIW3.js";import{D as _e}from"./DialogContentText-BudPzXZW.js";import"./request-BSxo6Ply.js";import"./LastPage-DEWP3WKD.js";import"./Close-G1yeCTF0.js";function gn(){const[p,L]=s.useState("%"),[S,w]=s.useState([]),[o,T]=s.useState([]),[x,B]=s.useState(1),[ae,re]=s.useState(0),[Xe,I]=s.useState(!1),{id:j}=Te(),W=Ce();s.useState(null);const[C,d]=s.useState({open:!1,message:"",severity:"success"}),[ie,$]=s.useState(!1),[v,te]=s.useState(!1),[f,A]=s.useState(""),[b,se]=s.useState(""),[oe,P]=s.useState(!1),le=Ke({tenPhieu:k().required("Tên phiếu giảm giá là bắt buộc"),giaTri:k().required("Giá trị là bắt buộc").test("is-valid-value",(n,r)=>{if(!n)return r.createError({message:"Giá trị là bắt buộc"});const t=new c(n.replace(/\./g,""));if(p==="%"){if(!t.isGreaterThan(0))return r.createError({message:"Giá trị phải lớn hơn 0%"});if(!t.isLessThanOrEqualTo(100))return r.createError({message:"Giá trị không được vượt quá 100%"})}else if(p==="$"){if(!t.isGreaterThan(0))return r.createError({message:"Giá trị phải lớn hơn 0$"})}else return r.createError({message:"Loại phiếu không hợp lệ"});return!0}),giaTriToiDa:k().required("Giá trị tối đa là bắt buộc").test("is-big-decimal","Giá trị phải lớn hơn 0",n=>n?new c(n.replace(/\./g,"")).isGreaterThan(0):!1).test("is-less-than-or-equal-to-dieuKien","Giá trị tối đa phải nhỏ hơn hoặc bằng điều kiện",function(n){const{dieuKien:r}=this.parent;if(!n||!r)return!1;const t=new c(n.replace(/\./g,"")),h=new c(r.replace(/\./g,""));return t.isLessThanOrEqualTo(h)}).test("is-giamToiDa-equal-giaTri","Giá trị tối đa phải bằng giá trị khi loại giảm giá là $",function(n){const{giaTri:r}=this.parent;if(p==="$"){const t=new c(n.replace(/\./g,"")),h=new c(r.replace(/\./g,""));return t.isEqualTo(h)}return!0}),soLuong:Fe().required("Số lượng là bắt buộc").positive("Số lượng phải lớn hơn 0").integer("Số lượng phải là số nguyên"),dieuKien:k().required("Điều kiện là bắt buộc").test("is-big-decimal","Điều kiện phải lớn hơn 10",n=>n?new c(n.replace(/\./g,"")).isGreaterThan(10):!1),tuNgay:U().min(new Date,"Từ ngày phải là ngày trong tương lai").required("Từ ngày là bắt buộc"),denNgay:U().min(He("tuNgay"),"Đến ngày phải sau từ ngày").required("Đến ngày là bắt buộc")});s.useEffect(()=>{he()},[x,f,b,j]);const he=async()=>{I(!0);try{let n;f&&b==""?n=await we(x-1,f):b!==""&&f==""?n=await Be(x-1,b):b==""&&f==""&&(n=await Y(x-1)),w(n.content),re(n.totalPages)}catch(n){console.error(n)}finally{I(!1)}};s.useEffect(()=>{ce(),fe()},[j]);const ce=async()=>{try{const n=await Y(x-1);w(n.content)}catch(n){console.error(n)}},ue=n=>{const r={width:"100px",textAlign:"center"};switch(n){case 0:return e.jsx(m,{label:"Đồng",color:"default",sx:{...r,backgroundColor:"#CD853F",color:"#FFFFFF"}});case 1:return e.jsx(m,{label:"Bạc",color:"default",sx:{...r,backgroundColor:"#C0C0C0",color:"#000000"}});case 2:return e.jsx(m,{label:"Vàng",color:"default",sx:{...r,backgroundColor:"#FFD700",color:"#000000"}});case 3:return e.jsx(m,{label:"Bạch Kim",color:"default",sx:{...r,backgroundColor:"#E5E4E2",color:"#000000"}});case 4:return e.jsx(m,{label:"Kim Cương",color:"default",sx:{...r,backgroundColor:"#363636",color:"#FFFFFF"}});default:return e.jsx(m,{label:"Không xác định",color:"default",sx:{...r,backgroundColor:"#FFFFFF",color:"#000000"}})}},ge=n=>{const r=n.target.value;se(r),B(1),A("")},de=()=>{W("/phieugiamgia/danhsachphieugiamgia")};s.useEffect(()=>{console.log("Danh sách khách hàng đã chọn:",o)},[]),s.useEffect(()=>{o.length>a.values.soLuong&&(a.setFieldValue("soLuong",o.length),d({open:!0,message:`Số lượng khách hàng đã chọn (${o.length}) nhiều hơn số lượng phiếu đã nhập, số lượng phiếu đã được tự động điều chỉnh.`,severity:"info"}))},[o]);const a=Le({initialValues:{tenPhieu:"",giaTri:"",giaTriToiDa:"",soLuong:"",dieuKien:"",tuNgay:"",denNgay:"",kieu:"1"},validationSchema:le,onSubmit:async n=>{var r,t;try{if(P(!0),n.kieu==="2"&&o.length>n.soLuong){d({open:!0,message:`Số lượng khách hàng được chọn (${o.length}) nhiều hơn số lượng phiếu (${n.soLuong}). Vui lòng tăng số lượng phiếu.`,severity:"error"});return}if(n.kieu==="2"&&o.length<1){d({open:!0,message:"Vui lòng chọn khách hàng cho phiếu giảm giá.",severity:"error"});return}debugger;const h={ten:n.tenPhieu,giaTriDonToiThieu:new c(String(n.dieuKien).replace(/\./g,"")).toFixed(),ngayBatDau:q(n.tuNgay),ngayHetHan:q(n.denNgay),loaiGiamGia:p==="%"?1:2,giaTriGiamGia:new c(String(n.giaTri).replace(/\./g,"")).toFixed(),giamToiDa:new c(String(n.giaTriToiDa).replace(/\./g,"")).toFixed(),phamViApDung:n.kieu,soLuong:n.soLuong,listKhachHang:o};let G;j?(G=await N.put(`http://localhost:8080/api/coupons/update/${j}`,h),d({open:!0,message:"Phiếu giảm giá đã được cập nhật thành công!",severity:"success"})):(G=await N.post("http://localhost:8080/api/coupons/add",h),d({open:!0,message:"Phiếu giảm giá đã được tạo thành công!",severity:"success"})),setTimeout(()=>{W("/phieugiamgia/danhsachphieugiamgia")},3e3)}catch(h){const je=(((t=(r=h.response)==null?void 0:r.data)==null?void 0:t.error)||"Đã xảy ra lỗi!").split(":")[1].split(":")[0].trim();d({open:!0,message:`Lỗi: ${je}`,severity:"error"})}finally{P(!1)}}}),E=n=>{L(n)},me=n=>{T(r=>{const t=Array.isArray(r)&&r.includes(n)?r.filter(h=>h!==n):[...Array.isArray(r)?r:[],n];return console.log("Selected KhachHang within handler:",t),t})},V=n=>[{id:0,name:"Chưa áp dụng",color:"gray"},{id:1,name:"Đang áp dụng",color:"green"},{id:2,name:"Đã hết hạn",color:"red"},{id:3,name:"Đã hủy",color:"orange"}].find(t=>t.id===n)||{name:"Không xác định",color:"default"},pe=(n,r)=>{B(r)},xe=n=>{const r={year:"numeric",month:"2-digit",day:"2-digit"};return new Date(n).toLocaleDateString("vi-VN",r)};function q(n){return n?n.length===16?`${n}:00`:(n.length===19,n):""}const O=()=>{d({...C,open:!1}),P(!1)},fe=async()=>{try{const r=(await N.get(`http://localhost:8080/api/coupons/detail/${j}`)).data;a.setValues({stat:r.data.trangThai,maPhieu:r.data.ma,tenPhieu:r.data.ten,giaTri:r.data.giaTriGiamGia,giaTriToiDa:r.data.giamToiDa,soLuong:r.data.soLuong,dieuKien:r.data.giaTriDonToiThieu,tuNgay:r.data.ngayBatDau,denNgay:r.data.ngayHetHan,kieu:r.data.phamViApDung.toString()}),L(r.data.loaiGiamGia===1?"%":"$");const t=r.data.khachHangPhieuGiamGias||[];T(t)}catch(n){console.error("Error fetching coupon detail:",n)}},l=location.pathname.includes("/phieugiamgia/chitietphieugiamgia"),be=()=>{$(!0)},D=n=>{$(!1),n&&a.handleSubmit()};function R(n){return String(n||"").replace(/\D/g,"").replace(/\B(?=(\d{3})+(?!\d))/g,".")}const ye=()=>{T(v?[]:S.map(n=>n.id)),te(!v)};return e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:6,children:e.jsxs(M,{style:{padding:"16px",height:"100%"},children:[l&&e.jsxs(i,{item:!0,xs:12,sx:{mb:2},children:[e.jsx(K,{variant:"h6",children:"Trạng thái phiếu:"}),e.jsx(m,{label:V(a.values.stat).name,sx:{backgroundColor:V(a.values.stat).color,color:"white",fontWeight:"bold"}})]}),e.jsxs("form",{onSubmit:a.handleSubmit,children:[e.jsx(g,{label:"Mã Phiếu Giảm Giá",name:"maPhieu",fullWidth:!0,margin:"normal",value:a.values.maPhieu,onChange:a.handleChange,error:a.touched.maPhieu&&!!a.errors.maPhieu,helperText:a.touched.maPhieu&&a.errors.maPhieu,InputProps:{readOnly:!0},InputLabelProps:{shrink:!0}}),e.jsx(g,{label:"Tên Phiếu Giảm Giá",name:"tenPhieu",fullWidth:!0,margin:"normal",InputProps:{readOnly:l},value:a.values.tenPhieu,onChange:a.handleChange,error:a.touched.tenPhieu&&!!a.errors.tenPhieu,helperText:a.touched.tenPhieu&&a.errors.tenPhieu}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:6,children:e.jsx(g,{label:"Giá trị giảm giá",name:"giaTri",fullWidth:!0,margin:"normal",value:a.values.giaTri,onChange:a.handleChange,error:a.touched.giaTri&&!!a.errors.giaTri,helperText:a.touched.giaTri&&a.errors.giaTri,InputProps:{readOnly:l,endAdornment:e.jsxs(z,{position:"end",children:[e.jsx(_,{onClick:()=>{l||E("%")},color:p==="%"?"primary":"default",children:e.jsx(De,{})}),e.jsx(_,{onClick:()=>{l||E("$")},color:p==="$"?"primary":"default",children:e.jsx(Ge,{})})]})}})}),e.jsx(i,{item:!0,xs:6,children:e.jsx(g,{label:" Giá trị giảm giá tối đa",name:"giaTriToiDa",fullWidth:!0,margin:"normal",value:R(a.values.giaTriToiDa),onChange:a.handleChange,error:a.touched.giaTriToiDa&&!!a.errors.giaTriToiDa,helperText:a.touched.giaTriToiDa&&a.errors.giaTriToiDa,InputProps:{readOnly:l,endAdornment:e.jsx(z,{position:"end",children:e.jsx(K,{sx:{color:"orange",fontWeight:"bold"},children:"₫"})})}})})]}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:6,children:e.jsx(g,{label:"Số lượng",value:a.values.soLuong,onChange:a.handleChange,variant:"outlined",fullWidth:!0,margin:"normal",name:"soLuong",helperText:a.touched.soLuong&&a.errors.soLuong?a.errors.soLuong:"",error:a.touched.soLuong&&!!a.errors.soLuong})}),e.jsx(i,{item:!0,xs:6,children:e.jsx(g,{label:"Giá trị đơn tối thiểu",name:"dieuKien",fullWidth:!0,margin:"normal",InputProps:{readOnly:l},value:R(a.values.dieuKien),onChange:a.handleChange,error:a.touched.dieuKien&&!!a.errors.dieuKien,helperText:a.touched.dieuKien&&a.errors.dieuKien})})]}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:6,children:e.jsx(g,{label:"Từ ngày",name:"tuNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:l},value:a.values.tuNgay,onChange:a.handleChange,InputLabelProps:{shrink:!0},error:a.touched.tuNgay&&!!a.errors.tuNgay,helperText:a.touched.tuNgay&&a.errors.tuNgay})}),e.jsx(i,{item:!0,xs:6,children:e.jsx(g,{label:"Đến ngày",name:"denNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:l},value:a.values.denNgay,InputLabelProps:{shrink:!0},onChange:a.handleChange,error:a.touched.denNgay&&!!a.errors.denNgay,helperText:a.touched.denNgay&&a.errors.denNgay})})]}),e.jsxs(i,{container:!0,justifyContent:"flex-start",alignItems:"center",spacing:2,children:[e.jsx(i,{item:!0,children:e.jsx(F,{component:"legend",children:"Phạm vi áp dụng"})}),e.jsx(i,{item:!0,children:e.jsxs(ke,{row:!0,"aria-label":"phạm vi áp dụng",name:"kieu",value:a.values.kieu,onChange:n=>{l||a.handleChange(n)},children:[e.jsx(X,{value:"1",control:e.jsx(J,{}),label:"Công khai"}),e.jsx(X,{value:"2",control:e.jsx(J,{}),label:"Cá nhân hóa"})]})})]}),!l&&e.jsx(H,{fullWidth:!0,variant:"contained",sx:{mt:2},onClick:be,disabled:oe,children:"Lưu"})]})]})}),e.jsx(i,{item:!0,xs:6,children:e.jsxs(M,{style:{padding:"16px",height:"100%"},children:[e.jsx(K,{variant:"h6",gutterBottom:!0,children:"Chọn khách hàng"}),e.jsx(Z,{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",mb:2,p:2,sx:{backgroundColor:"white",boxShadow:"0 4px 8px rgba(0, 0, 0, 0.1)",borderRadius:"8px",width:"100%"},children:e.jsxs(i,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(i,{item:!0,xs:5,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(F,{component:"legend",sx:{mb:1,fontWeight:"bold",fontSize:"1rem",color:"text.primary"},children:"Tìm kiếm"}),e.jsx(g,{value:f,onChange:n=>A(n.target.value),variant:"outlined",placeholder:"Nhập tên khách hàng",fullWidth:!0,InputProps:{style:{borderRadius:"8px"}}})]})}),e.jsx(Se,{orientation:"vertical",flexItem:!0,sx:{mx:2}}),e.jsx(i,{item:!0,xs:5,children:e.jsxs(Q,{fullWidth:!0,children:[e.jsx(F,{component:"legend",sx:{mb:1,fontWeight:"bold",fontSize:"1rem",color:"text.primary"},children:"Hạng khách hàng"}),e.jsxs(ve,{labelId:"hang-khach-hang-label",id:"hang-khach-hang-select",value:b,onChange:ge,displayEmpty:!0,fullWidth:!0,sx:{borderRadius:"8px",backgroundColor:"white"},children:[e.jsx(y,{value:"",children:"-- Tất cả khách hàng --"}),e.jsx(y,{value:0,children:"Đồng"}),e.jsx(y,{value:1,children:"Bạc"}),e.jsx(y,{value:2,children:"Vàng"}),e.jsx(y,{value:3,children:"Bạch Kim"}),e.jsx(y,{value:4,children:"Kim Cương"})]})]})}),e.jsx(Pe,{color:"primary","aria-label":"back",sx:{position:"fixed",bottom:16,right:16},onClick:de,children:e.jsx(Ne,{})})]})}),e.jsx(Ie,{children:e.jsxs(We,{children:[e.jsx($e,{children:e.jsxs(ee,{children:[e.jsx(u,{padding:"checkbox",children:e.jsx(ne,{indeterminate:o.length>0&&o.length<S.length,checked:v,onChange:ye,disabled:l||a.values.kieu==="1"})}),e.jsx(u,{children:"Tên khách hàng"}),e.jsx(u,{children:"Số điện thoại"}),e.jsx(u,{children:"Ngày sinh"}),e.jsx(u,{children:"Hạng khách hàng"})]})}),e.jsx(Ae,{children:S.map(n=>e.jsxs(ee,{children:[e.jsx(u,{padding:"checkbox",children:e.jsx(ne,{checked:Array.isArray(o)&&o.includes(n.id),onChange:()=>me(n.id),disabled:l||a.values.kieu==="1"})}),e.jsx(u,{children:n.ten}),e.jsx(u,{children:n.sdt}),e.jsx(u,{children:xe(n.ngaySinh)}),e.jsx(u,{children:ue(n.hangKhachHang)})]},n.id))})]})}),e.jsx(Z,{display:"fixed",justifyContent:"center",alignItems:"center",marginTop:2,children:e.jsx(Ee,{count:ae,page:x,onChange:pe,color:"primary"})})]})}),e.jsx(Ve,{open:C.open,autoHideDuration:6e3,onClose:O,anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(qe,{onClose:O,severity:C.severity,sx:{width:"100%"},children:C.message})}),e.jsxs(Oe,{open:ie,onClose:()=>D(!1),children:[e.jsx(Re,{children:"Xác nhận"}),e.jsx(Me,{children:e.jsx(_e,{children:"Bạn có chắc chắn muốn lưu thông tin phiếu giảm giá này?"})}),e.jsxs(ze,{children:[e.jsx(H,{onClick:()=>D(!1),color:"primary",children:"Hủy"}),e.jsx(H,{onClick:()=>D(!0),color:"primary",autoFocus:!0,children:"Xác nhận"})]})]})]})}export{gn as default};

import{r as t,a as De,b as Pe,c as G,j as e,G as i,d as Q,T as K,e as d,f as c,I as U,h as Y,F as N,R as ve,i as Z,k as ee,m as H,B as ne,n as ae,D as Fe,o as Ge,p as Ke}from"./index-BIssY3ES.js";import{B as u,d as Ne,a as He}from"./bignumber-DjpusbG5.js";import{c as Le,a as L,b as we,d as re,e as Be}from"./index.esm-BdF2LkeS.js";import{u as Ie}from"./formik.esm-CdeNcky_.js";import{g as We,a as Ae,b as ie}from"./customerService-XJayTiK5.js";import{d as $e}from"./ArrowBack-DgGWV8yI.js";import{M as b}from"./MenuItem-DXPtbgVP.js";import{T as Ee,a as Ve,b as Oe,c as te,d as qe}from"./TableRow-DRER82D7.js";import{T as h}from"./TableCell-BTwc7VYq.js";import{C as oe}from"./Checkbox-B6XmajkB.js";import{P as Re}from"./Pagination-COFE68zz.js";import{S as Me,A as ze}from"./Snackbar-DXnsCQKE.js";import{D as _e,a as Xe,b as Je,c as Qe}from"./DialogTitle-CNaKTOiI.js";import{D as Ue}from"./DialogContentText-BUcCQ4bP.js";import"./request-CBzxMAFn.js";import"./LastPage-DAj5RLva.js";import"./Close-DqFvtwpG.js";function fn(){const[m,w]=t.useState("%"),[S,B]=t.useState([]),[o,j]=t.useState([]),[p,I]=t.useState(1),[se,le]=t.useState(0),[Ye,W]=t.useState(!1),{id:y}=De(),A=Pe();t.useState(null);const[T,g]=t.useState({open:!1,message:"",severity:"success"}),[he,$]=t.useState(!1),[D,ce]=t.useState(!1),[x,E]=t.useState(""),[f,ue]=t.useState(""),[ge,P]=t.useState(!1),de=Le({tenPhieu:L().required("Tên phiếu giảm giá là bắt buộc"),giaTri:L().required("Giá trị là bắt buộc").test("is-valid-value",(n,r)=>{if(!n)return r.createError({message:"Giá trị là bắt buộc"});const l=new u(n.replace(/\./g,""));if(m==="%"){if(!l.isGreaterThan(0))return r.createError({message:"Giá trị phải lớn hơn 0%"});if(!l.isLessThanOrEqualTo(100))return r.createError({message:"Giá trị không được vượt quá 100%"})}else if(m==="$"){if(!l.isGreaterThan(0))return r.createError({message:"Giá trị phải lớn hơn 0$"})}else return r.createError({message:"Loại phiếu không hợp lệ"});return!0}),soLuong:we().required("Số lượng là bắt buộc").positive("Số lượng phải lớn hơn 0").integer("Số lượng phải là số nguyên"),dieuKien:L().required("Điều kiện là bắt buộc").test("is-big-decimal","Điều kiện phải lớn hơn 10",n=>n?new u(n.replace(/\./g,"")).isGreaterThan(10):!1),tuNgay:re().min(new Date,"Từ ngày phải là ngày trong tương lai").required("Từ ngày là bắt buộc"),denNgay:re().min(Be("tuNgay"),"Đến ngày phải sau từ ngày").required("Đến ngày là bắt buộc")});t.useEffect(()=>{debugger;me()},[p,x,f,y]);const me=async()=>{W(!0);try{let n;x&&f==""?n=await We(p-1,x):f!==""&&x==""?n=await Ae(p-1,f):f==""&&x==""&&(n=await ie(p-1)),B(n.content),le(n.totalPages)}catch(n){console.error(n)}finally{W(!1)}};t.useEffect(()=>{pe(),Ce()},[y]);const pe=async()=>{try{const n=await ie(p-1);B(n.content)}catch(n){console.error(n)}},xe=n=>{const r={width:"100px",textAlign:"center"};switch(n){case 0:return e.jsx(d,{label:"Đồng",color:"default",sx:{...r,backgroundColor:"#CD853F",color:"#FFFFFF"}});case 1:return e.jsx(d,{label:"Bạc",color:"default",sx:{...r,backgroundColor:"#C0C0C0",color:"#000000"}});case 2:return e.jsx(d,{label:"Vàng",color:"default",sx:{...r,backgroundColor:"#FFD700",color:"#000000"}});case 3:return e.jsx(d,{label:"Bạch Kim",color:"default",sx:{...r,backgroundColor:"#E5E4E2",color:"#000000"}});case 4:return e.jsx(d,{label:"Kim Cương",color:"default",sx:{...r,backgroundColor:"#363636",color:"#FFFFFF"}});default:return e.jsx(d,{label:"Không xác định",color:"default",sx:{...r,backgroundColor:"#FFFFFF",color:"#000000"}})}},fe=n=>{const r=n.target.value;ue(r),I(1),E("")},be=()=>{A("/phieugiamgia/danhsachphieugiamgia")};t.useEffect(()=>{console.log("Danh sách khách hàng đã chọn:",o)},[]),t.useEffect(()=>{o.length>a.values.soLuong&&(a.setFieldValue("soLuong",o.length),g({open:!0,message:`Số lượng khách hàng đã chọn (${o.length}) nhiều hơn số lượng phiếu đã nhập, số lượng phiếu đã được tự động điều chỉnh.`,severity:"info"}))},[o]);const a=Ie({initialValues:{tenPhieu:"",giaTri:"",giaTriToiDa:"",soLuong:"",dieuKien:"",tuNgay:"",denNgay:"",kieu:"1"},validationSchema:de,onSubmit:async(n,{setErrors:r,validateForm:l})=>{var z,_;const C=await l();if(Object.keys(C).length>0){r(C);return}try{if(P(!0),n.kieu==="2"&&o.length>n.soLuong){g({open:!0,message:`Số lượng khách hàng được chọn (${o.length}) nhiều hơn số lượng phiếu (${n.soLuong}). Vui lòng tăng số lượng phiếu.`,severity:"error"});return}if(n.kieu==="2"&&o.length<1){g({open:!0,message:"Vui lòng chọn khách hàng cho phiếu giảm giá.",severity:"error"});return}const F=new u(String(n.giaTri).replace(/\./g,"")),X=n.giaTriToiDa===""||n.giaTriToiDa==null?new u(0):new u(String(n.giaTriToiDa).replace(/\./g,""));if(n.giaTriToiDa==null||n.giaTriToiDa===""){r({giaTriToiDa:"Giá trị tối đa không được để trống."});return}if(m==="$"&&!X.isEqualTo(F)){r({giaTriToiDa:"Giá trị tối đa phải bằng với giá trị giảm giá khi loại chiết khấu là tiền."});return}const k={ten:n.tenPhieu,giaTriDonToiThieu:new u(String(n.dieuKien).replace(/\./g,"")).toFixed(),ngayBatDau:q(n.tuNgay),ngayHetHan:q(n.denNgay),loaiGiamGia:m==="%"?1:2,giaTriGiamGia:new u(String(n.giaTri).replace(/\./g,"")).toFixed(),giamToiDa:n.giaTriToiDa===""?null:new u(String(n.giaTriToiDa).replace(/\./g,"")).toFixed(),phamViApDung:n.kieu,soLuong:n.soLuong,listKhachHang:o};let J;y?(J=await G.put(`http://localhost:8080/api/coupons/update/${y}`,k),g({open:!0,message:"Phiếu giảm giá đã được cập nhật thành công!",severity:"success"})):(J=await G.post("http://localhost:8080/api/coupons/add",k),g({open:!0,message:"Phiếu giảm giá đã được tạo thành công!",severity:"success"})),setTimeout(()=>{A("/phieugiamgia/danhsachphieugiamgia")},3e3)}catch(F){const k=(((_=(z=F.response)==null?void 0:z.data)==null?void 0:_.error)||"Đã xảy ra lỗi!").split(":")[1].split(":")[0].trim();g({open:!0,message:`Lỗi: ${k}`,severity:"error"})}finally{P(!1)}}}),V=n=>{w(n)},ye=n=>{j(r=>{const l=Array.isArray(r)&&r.includes(n)?r.filter(C=>C!==n):[...Array.isArray(r)?r:[],n];return console.log("Selected KhachHang within handler:",l),l})},O=n=>[{id:0,name:"Chưa áp dụng",color:"gray"},{id:1,name:"Đang áp dụng",color:"green"},{id:2,name:"Đã hết hạn",color:"red"},{id:3,name:"Đã hủy",color:"orange"}].find(l=>l.id===n)||{name:"Không xác định",color:"default"},je=(n,r)=>{I(r)},Te=n=>{const r={year:"numeric",month:"2-digit",day:"2-digit"};return new Date(n).toLocaleDateString("vi-VN",r)};function q(n){return n?n.length===16?`${n}:00`:(n.length===19,n):""}const R=()=>{g({...T,open:!1}),P(!1)},Ce=async()=>{try{debugger;const r=(await G.get(`http://localhost:8080/api/coupons/detail/${y}`)).data;a.setValues({stat:r.data.trangThai,maPhieu:r.data.ma,tenPhieu:r.data.ten,giaTri:r.data.giaTriGiamGia,giaTriToiDa:r.data.giamToiDa,soLuong:r.data.soLuong,dieuKien:r.data.giaTriDonToiThieu,tuNgay:r.data.ngayBatDau,denNgay:r.data.ngayHetHan,kieu:r.data.phamViApDung.toString()}),w(r.data.loaiGiamGia===1?"%":"$");const l=r.data.khachHangPhieuGiamGias||[];j(l)}catch(n){console.error("Error fetching coupon detail:",n)}},s=location.pathname.includes("/phieugiamgia/chitietphieugiamgia"),ke=()=>{$(!0)},v=n=>{$(!1),n&&a.handleSubmit()};function M(n){return String(n||"").replace(/\D/g,"").replace(/\B(?=(\d{3})+(?!\d))/g,".")}const Se=()=>{j(D?[]:S.map(n=>n.id)),ce(!D)};return e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:6,children:e.jsxs(Q,{style:{padding:"16px",height:"100%"},children:[s&&e.jsxs(i,{item:!0,xs:12,sx:{mb:2},children:[e.jsx(K,{variant:"h6",children:"Trạng thái phiếu:"}),e.jsx(d,{label:O(a.values.stat).name,sx:{backgroundColor:O(a.values.stat).color,color:"white",fontWeight:"bold"}})]}),e.jsxs("form",{onSubmit:a.handleSubmit,children:[e.jsx(c,{label:"Mã Phiếu Giảm Giá",name:"maPhieu",fullWidth:!1,margin:"normal",value:a.values.maPhieu,onChange:a.handleChange,error:a.touched.maPhieu&&!!a.errors.maPhieu,helperText:a.touched.maPhieu&&a.errors.maPhieu,InputProps:{readOnly:!0,inputProps:{tabIndex:-1},sx:{pointerEvents:"none",backgroundColor:"rgba(0, 0, 0, 0.04)"}},InputLabelProps:{shrink:!0},sx:{width:"200px"}}),e.jsx(c,{label:"Tên Phiếu Giảm Giá",name:"tenPhieu",fullWidth:!0,margin:"normal",InputProps:{readOnly:s},value:a.values.tenPhieu,onChange:a.handleChange,error:a.touched.tenPhieu&&!!a.errors.tenPhieu,helperText:a.touched.tenPhieu&&a.errors.tenPhieu}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:6,children:e.jsx(c,{label:"Giá trị giảm giá",name:"giaTri",fullWidth:!0,margin:"normal",value:a.values.giaTri,onChange:a.handleChange,error:a.touched.giaTri&&!!a.errors.giaTri,helperText:a.touched.giaTri&&a.errors.giaTri,InputProps:{readOnly:s,endAdornment:e.jsxs(U,{position:"end",children:[e.jsx(Y,{onClick:()=>{s||V("%")},color:m==="%"?"primary":"default",children:e.jsx(Ne,{})}),e.jsx(Y,{onClick:()=>{s||V("$")},color:m==="$"?"primary":"default",children:e.jsx(He,{})})]})}})}),e.jsx(i,{item:!0,xs:6,children:e.jsx(c,{label:" Giá trị giảm giá tối đa",name:"giaTriToiDa",fullWidth:!0,margin:"normal",value:M(a.values.giaTriToiDa),onChange:a.handleChange,error:a.touched.giaTriToiDa&&!!a.errors.giaTriToiDa,helperText:a.touched.giaTriToiDa&&a.errors.giaTriToiDa,InputProps:{readOnly:s,endAdornment:e.jsx(U,{position:"end",children:e.jsx(K,{sx:{color:"orange",fontWeight:"bold"},children:"₫"})})}})})]}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:6,children:e.jsx(c,{label:"Số lượng",value:a.values.soLuong,onChange:a.handleChange,variant:"outlined",fullWidth:!0,margin:"normal",name:"soLuong",helperText:a.touched.soLuong&&a.errors.soLuong?a.errors.soLuong:"",error:a.touched.soLuong&&!!a.errors.soLuong})}),e.jsx(i,{item:!0,xs:6,children:e.jsx(c,{label:"Giá trị đơn tối thiểu",name:"dieuKien",fullWidth:!0,margin:"normal",InputProps:{readOnly:s},value:M(a.values.dieuKien),onChange:a.handleChange,error:a.touched.dieuKien&&!!a.errors.dieuKien,helperText:a.touched.dieuKien&&a.errors.dieuKien})})]}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:6,children:e.jsx(c,{label:"Từ ngày",name:"tuNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:s},value:a.values.tuNgay,onChange:a.handleChange,InputLabelProps:{shrink:!0},error:a.touched.tuNgay&&!!a.errors.tuNgay,helperText:a.touched.tuNgay&&a.errors.tuNgay})}),e.jsx(i,{item:!0,xs:6,children:e.jsx(c,{label:"Đến ngày",name:"denNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:s},value:a.values.denNgay,InputLabelProps:{shrink:!0},onChange:a.handleChange,error:a.touched.denNgay&&!!a.errors.denNgay,helperText:a.touched.denNgay&&a.errors.denNgay})})]}),e.jsxs(i,{container:!0,justifyContent:"flex-start",alignItems:"center",spacing:2,children:[e.jsx(i,{item:!0,children:e.jsx(N,{component:"legend",children:"Phạm vi áp dụng"})}),e.jsx(i,{item:!0,children:e.jsxs(ve,{row:!0,"aria-label":"phạm vi áp dụng",name:"kieu",value:a.values.kieu,onChange:n=>{s||a.handleChange(n)},children:[e.jsx(Z,{value:"1",control:e.jsx(ee,{}),label:"Công khai"}),e.jsx(Z,{value:"2",control:e.jsx(ee,{}),label:"Cá nhân hóa"})]})})]}),!s&&e.jsx(H,{fullWidth:!0,variant:"contained",sx:{mt:2},onClick:ke,disabled:ge,children:"Lưu"})]})]})}),e.jsx(i,{item:!0,xs:6,children:e.jsxs(Q,{style:{padding:"16px",height:"100%"},children:[e.jsx(K,{variant:"h6",gutterBottom:!0,children:"Chọn khách hàng"}),e.jsx(ne,{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",mb:2,p:2,sx:{backgroundColor:"white",boxShadow:"0 4px 8px rgba(0, 0, 0, 0.1)",borderRadius:"8px",width:"100%"},children:e.jsxs(i,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(i,{item:!0,xs:5,children:e.jsxs(ae,{fullWidth:!0,children:[e.jsx(N,{component:"legend",sx:{mb:1,fontWeight:"bold",fontSize:"1rem",color:"text.primary"},children:"Tìm kiếm"}),e.jsx(c,{value:x,onChange:n=>E(n.target.value),variant:"outlined",placeholder:"Nhập tên khách hàng",fullWidth:!0,InputProps:{style:{borderRadius:"8px"}}})]})}),e.jsx(Fe,{orientation:"vertical",flexItem:!0,sx:{mx:2}}),e.jsx(i,{item:!0,xs:5,children:e.jsxs(ae,{fullWidth:!0,children:[e.jsx(N,{component:"legend",sx:{mb:1,fontWeight:"bold",fontSize:"1rem",color:"text.primary"},children:"Hạng khách hàng"}),e.jsxs(Ge,{labelId:"hang-khach-hang-label",id:"hang-khach-hang-select",value:f,onChange:fe,displayEmpty:!0,fullWidth:!0,sx:{borderRadius:"8px",backgroundColor:"white"},children:[e.jsx(b,{value:"",children:"-- Tất cả khách hàng --"}),e.jsx(b,{value:0,children:"Đồng"}),e.jsx(b,{value:1,children:"Bạc"}),e.jsx(b,{value:2,children:"Vàng"}),e.jsx(b,{value:3,children:"Bạch Kim"}),e.jsx(b,{value:4,children:"Kim Cương"})]})]})}),e.jsx(Ke,{color:"primary","aria-label":"back",sx:{position:"fixed",bottom:16,right:16},onClick:be,children:e.jsx($e,{})})]})}),e.jsx(Ee,{children:e.jsxs(Ve,{children:[e.jsx(Oe,{children:e.jsxs(te,{children:[e.jsx(h,{padding:"checkbox",children:e.jsx(oe,{indeterminate:o.length>0&&o.length<S.length,checked:D,onChange:Se,disabled:s||a.values.kieu==="1"})}),e.jsx(h,{children:"Tên khách hàng"}),e.jsx(h,{children:"Số điện thoại"}),e.jsx(h,{children:"Ngày sinh"}),e.jsx(h,{children:"Hạng khách hàng"})]})}),e.jsx(qe,{children:S.map(n=>e.jsxs(te,{children:[e.jsx(h,{padding:"checkbox",children:e.jsx(oe,{checked:Array.isArray(o)&&o.includes(n.id),onChange:()=>ye(n.id),disabled:s||a.values.kieu==="1"})}),e.jsx(h,{children:n.ten}),e.jsx(h,{children:n.sdt}),e.jsx(h,{children:Te(n.ngaySinh)}),e.jsx(h,{children:xe(n.hangKhachHang)})]},n.id))})]})}),e.jsx(ne,{display:"fixed",justifyContent:"center",alignItems:"center",marginTop:2,children:e.jsx(Re,{count:se,page:p,onChange:je,color:"primary"})})]})}),e.jsx(Me,{open:T.open,autoHideDuration:6e3,onClose:R,anchorOrigin:{vertical:"top",horizontal:"right"},children:e.jsx(ze,{onClose:R,severity:T.severity,sx:{width:"100%"},children:T.message})}),e.jsxs(_e,{open:he,onClose:()=>v(!1),children:[e.jsx(Xe,{children:"Xác nhận"}),e.jsx(Je,{children:e.jsx(Ue,{children:"Bạn có chắc chắn muốn lưu thông tin phiếu giảm giá này?"})}),e.jsxs(Qe,{children:[e.jsx(H,{onClick:()=>v(!1),color:"primary",children:"Hủy"}),e.jsx(H,{onClick:()=>v(!0),color:"primary",autoFocus:!0,children:"Xác nhận"})]})]})]})}export{fn as default};

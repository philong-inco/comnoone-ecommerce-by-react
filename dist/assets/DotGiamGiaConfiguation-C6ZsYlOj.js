import{r as o,a as Pe,b as we,z as $e,c as j,j as e,G as O,d as G,f as u,I,h as ee,T as N,m as L,D as Be,n as Ae,R as Ee,i as te,k as ae,B as y,p as Oe}from"./index-BIssY3ES.js";import{d as Le}from"./ArrowBack-DgGWV8yI.js";import{c as Fe,a as F,d as re}from"./index.esm-BdF2LkeS.js";import{u as We}from"./formik.esm-CdeNcky_.js";import{B as f,d as qe,a as Re}from"./bignumber-DjpusbG5.js";import{g as He,a as ie}from"./dotGiamGiaService-jBadcmU4.js";import{T as ne,a as se,b as oe,c as b,d as le}from"./TableRow-DRER82D7.js";import{T as n}from"./TableCell-BTwc7VYq.js";import{C as ce}from"./Checkbox-B6XmajkB.js";import{P as ze}from"./Pagination-COFE68zz.js";import{T as Ke,a as Me}from"./Tabs-FYaVCitM.js";import{S as Ve,A as _e}from"./Snackbar-DXnsCQKE.js";import{D as Xe,a as Qe,b as Ue,c as Je}from"./DialogTitle-CNaKTOiI.js";import{D as Ye}from"./DialogContentText-BUcCQ4bP.js";import"./LastPage-DAj5RLva.js";import"./KeyboardArrowRight-DCS3bnxJ.js";import"./Close-DqFvtwpG.js";function ft(){const[W,q]=o.useState({}),[P,R]=o.useState([]),[g,H]=o.useState([]),[z,K]=o.useState({}),[he,M]=o.useState(!1),[V,de]=o.useState(0),{id:T}=Pe(),_=we(),X=$e(),[S,p]=o.useState({open:!1,message:"",severity:"success"}),[Ze,w]=o.useState(!1),[d,Q]=o.useState(!1),[m,$]=o.useState("%"),[C,ue]=o.useState(1),[ge,pe]=o.useState(1),[B,Ie]=o.useState(5),[me,U]=o.useState(!1);o.useEffect(()=>{J(C,B)},[C,B]),o.useEffect(()=>{X.pathname.includes("/dotgiamgia/cauhinhdotgiamgia/view")?Q(!0):Q(!1)},[X,T]),o.useEffect(()=>{const t=async()=>{debugger;try{const a=await Promise.all(g.map(async r=>{const s=await ie(r);return{sanPhamId:r,productDetails:s.data.data}}));q(r=>{const s={...r};return a.forEach(({sanPhamId:l,productDetails:x})=>{s[l]=x}),s})}catch{p({open:!0,message:"không thể tìm được sản phẩm chi tiết",severity:"error"})}};g.length>0&&t()},[g]),o.useEffect(()=>{Ce(),J(C,B)},[T]);const J=async(t,a)=>{M(!0);try{const r=await He(t-1,a);R(r.data||[]),pe(r.totalPage||1)}catch(r){console.error("Lỗi khi tải dữ liệu sản phẩm:",r),p({open:!0,message:"Lỗi khi tải dữ liệu sản phẩm",severity:"error"})}finally{M(!1)}},xe=(t,a)=>{ue(a)},fe=()=>{_("/dotgiamgia/danhsachdotgiamgia")},Te=async t=>{debugger;H(a=>{const r=a.includes(t)?a.filter(s=>s!==t):[...a,t];return W[t]||(async()=>{try{const l=(await ie(t)).data.data;q(x=>({...x,[t]:l}))}catch{p({open:!0,message:"Lỗi khi tải sản phẩm chi tiết",severity:"error"})}})(),r})},je=(t,a)=>{debugger;K(r=>{const s=r[t]||[];return s.includes(a.id)?{...r,[t]:s.filter(l=>l!==a.id)}:{...r,[t]:[...s,a.id]}})},ye=(t,a)=>{de(a)};function Y(t){return t?t.length===16?`${t}:00`:(t.length===19,t):""}const i=We({initialValues:{tenPhieu:"",giaTri:"",giaTriToiDa:"",tuNgay:"",denNgay:"",loaiChietKhau:"1"},validationSchema:Fe({tenPhieu:F().required("Tên đợt giảm giá là bắt buộc"),giaTri:F().required("Giá trị là bắt buộc").test("is-valid-value",(t,a)=>{if(!t)return a.createError({message:"Giá trị là bắt buộc"});const r=new f(t.replace(/\./g,""));if(m==="%"){if(!r.isGreaterThan(0))return a.createError({message:"Giá trị phải lớn hơn 0%"});if(!r.isLessThanOrEqualTo(100))return a.createError({message:"Giá trị không được vượt quá 100%"})}else if(m==="$"){if(!r.isGreaterThan(0))return a.createError({message:"Giá trị phải lớn hơn 0$"})}else return a.createError({message:"Loại phiếu không hợp lệ"});return!0}),giaTriToiDa:F().required("Giá trị tối đa không được để trống").test("is-correct-value","Giá trị tối đa không hợp lệ",function(t){const{giaTri:a}=this.parent,r=new f(a.replace(/\./g,"")),s=t?new f(t.replace(/\./g,"")):null;return m==="$"&&(!s||!s.isEqualTo(r))?this.createError({message:"Giá trị tối đa phải bằng với giá trị giảm giá khi loại chiết khấu là tiền."}):!0}),tuNgay:re().required("Ngày bắt đầu là bắt buộc").min(new Date,"Ngày bắt đầu phải từ hiện tại trở đi"),denNgay:re().required("Ngày kết thúc là bắt buộc").when("tuNgay",(t,a)=>a.min(t,"Ngày kết thúc phải sau ngày bắt đầu"))}),onSubmit:async(t,{setErrors:a,validateForm:r})=>{const s=await r();if(Object.keys(s).length>0){a(s);return}try{w(!0);const l=Object.values(z).flat(),x=new f(String(t.giaTri).replace(/\./g,"")),c=t.giaTriToiDa===""?new f(0):new f(String(t.giaTriToiDa).replace(/\./g,""));if(m==="$"&&!c.isEqualTo(x)){a({giaTriToiDa:"Giá trị tối đa phải bằng với giá trị giảm giá khi loại chiết khấu là tiền."});return}const h={ten:t.tenPhieu,moTa:t.moTa,giaTriGiam:t.giaTri,giamToiDa:t.giaTriToiDa===""?null:new f(String(t.giaTriToiDa).replace(/\./g,"")).toFixed(),loaiChietKhau:m==="%"?1:2,thoiGianBatDau:Y(t.tuNgay),thoiGianKetThuc:Y(t.denNgay),listSanPhamChiTiet:l};let v;T?(v=await j.put(`http://localhost:8080/api/v1/discounts/update/${T}`,h),p({open:!0,message:"Đợt giảm giá đã được cập nhật thành công!",severity:"success"})):(v=await j.post("http://localhost:8080/api/v1/discounts/add",h),p({open:!0,message:"Đợt giảm giá đã được tạo thành công!",severity:"success"})),setTimeout(()=>{_("/dotgiamgia/danhsachdotgiamgia")},3e3)}catch(l){l.response&&l.response.data&&l.response.data.errors?a(l.response.data.errors):(console.log(l),p({open:!0,message:"Đã xảy ra lỗi!",severity:"error"}))}finally{w(!1)}}}),A=t=>{U(!1),t&&i.handleSubmit()},Z=()=>{p({...S,open:!1}),w(!1)},be=()=>{U(!0)};function Se(t){return String(t||"").replace(/\D/g,"").replace(/\B(?=(\d{3})+(?!\d))/g,".")}const Ce=async()=>{try{debugger;const a=(await j.get(`http://localhost:8080/api/v1/discounts/${T}`)).data;i.setValues({stat:a.trangThai,maPhieu:a.ma,tenPhieu:a.ten,moTa:a.moTa,giaTri:a.giaTriGiam,tuNgay:a.thoiGianBatDau,denNgay:a.thoiGianKetthuc,giaTriToiDa:a.giamToiDa}),$(a.loaiChietKhau===1?"%":"$");const r=a.spctDotGiamGias||[],s=await Promise.all(r.map(async c=>(await j.get(`http://localhost:8080/api/san-pham-chi-tiet/get-by-productdetail-id?idProductDetail=${c}`)).data.data)),l=s.map(c=>parseInt(c.sanPhamId)).filter((c,h,v)=>!isNaN(c)&&v.indexOf(c)===h),x=s.reduce((c,h)=>(c[h.sanPhamId]||(c[h.sanPhamId]=[]),c[h.sanPhamId].push(h.id),c),{});H(l),K(x)}catch(t){console.error("Error fetching DGG detail:",t)}},[E,De]=o.useState("0"),ke=t=>{const a=t.target.value.toString().trim();E==="0"?k(r=>({...r,tenSanPham:a,ma:""})):E==="1"&&k(r=>({...r,ma:a,tenSanPham:""}))},ve=t=>{const a=t.target.value;De(a),a==="0"?k(r=>({...r,tenSanPham:D.ma,ma:""})):a==="1"&&k(r=>({...r,ma:D.tenSanPham,tenSanPham:""}))};o.useState(0);const Ge="http://localhost:8080/api/san-pham/find/filter-id?",[D,k]=o.useState({page:0,size:"5",tenSanPham:"",ma:"",trangThai:1});o.useEffect(()=>{Ne()},[D]);const Ne=async()=>{const t=Object.entries(D).filter(([s,l])=>l!=="").map(([s,l])=>`${s}=${l}`).join("&"),a=Ge+t,r=await j.get(a);R(r.data.data),setTotalElement(parseInt(r.data.totalElement))};return e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:4,children:e.jsx(G,{style:{padding:"16px",height:"100%"},children:e.jsxs("form",{onSubmit:i.handleSubmit,children:[e.jsx(u,{label:"Mã Đợt Giảm Giá",name:"maPhieu",fullWidth:!0,margin:"normal",value:i.values.maPhieu,onChange:i.handleChange,InputProps:{readOnly:!0},InputLabelProps:{shrink:!0}}),e.jsx(u,{label:"Tên Đợt Giảm Giá",name:"tenPhieu",fullWidth:!0,margin:"normal",value:i.values.tenPhieu,onChange:i.handleChange,error:i.touched.tenPhieu&&!!i.errors.tenPhieu,helperText:i.touched.tenPhieu&&i.errors.tenPhieu}),e.jsx(u,{label:"Giá trị phiếu",name:"giaTri",fullWidth:!0,margin:"normal",value:i.values.giaTri,onChange:i.handleChange,error:i.touched.giaTri&&!!i.errors.giaTri,helperText:i.touched.giaTri&&i.errors.giaTri,InputProps:{readOnly:d,endAdornment:e.jsxs(I,{position:"end",children:[e.jsx(ee,{onClick:()=>!d&&$("%"),color:m==="%"?"primary":"default",children:e.jsx(qe,{})}),e.jsx(ee,{onClick:()=>!d&&$("$"),color:m==="$"?"primary":"default",children:e.jsx(Re,{})})]})}}),e.jsx(u,{label:" Giá trị giảm giá tối đa",name:"giaTriToiDa",fullWidth:!0,margin:"normal",value:Se(i.values.giaTriToiDa),onChange:i.handleChange,error:i.touched.giaTriToiDa&&!!i.errors.giaTriToiDa,helperText:i.touched.giaTriToiDa&&i.errors.giaTriToiDa,InputProps:{readOnly:d,endAdornment:e.jsx(I,{position:"end",children:e.jsx(N,{sx:{color:"orange",fontWeight:"bold"},children:"₫"})})}}),e.jsx(u,{label:"Từ ngày",name:"tuNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:d},value:i.values.tuNgay,onChange:i.handleChange,InputLabelProps:{shrink:!0},error:i.touched.tuNgay&&!!i.errors.tuNgay,helperText:i.touched.tuNgay&&i.errors.tuNgay}),e.jsx(u,{label:"Đến ngày",name:"denNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:d},value:i.values.denNgay,onChange:i.handleChange,InputLabelProps:{shrink:!0},error:i.touched.denNgay&&!!i.errors.denNgay,helperText:i.touched.denNgay&&i.errors.denNgay}),e.jsx(u,{label:"Mô tả đợt giảm giá",name:"moTa",fullWidth:!0,margin:"normal",value:i.values.moTa,InputLabelProps:{shrink:!0},onChange:i.handleChange,error:i.touched.moTa&&!!i.errors.moTa,helperText:i.touched.moTa&&i.errors.moTa,sx:{fontFamily:"Arial, sans-serif"}}),!d&&e.jsx(L,{fullWidth:!0,variant:"contained",sx:{mt:2},onClick:be,children:"Lưu"})]})})}),e.jsxs(O,{item:!0,xs:8,children:[e.jsxs(G,{style:{padding:"16px",height:"100%"},children:[e.jsx(N,{variant:"h6",children:"Danh sách sản phẩm"}),e.jsx(Be,{}),e.jsxs("div",{style:{display:"flex",padding:10,paddingTop:20},children:[e.jsx(u,{sx:{maxHeight:"10px"},color:"secondary",onChange:ke,id:"outlined-basic",label:"Nhập từ khóa",variant:"outlined"}),e.jsx("div",{style:{marginLeft:10,display:"flex",alignItems:"center"},children:e.jsx(Ae,{children:e.jsxs(Ee,{"aria-labelledby":"demo-controlled-radio-buttons-group",name:"controlled-radio-buttons-group",value:E,row:!0,onChange:ve,children:[e.jsx(te,{value:"0",control:e.jsx(ae,{color:"secondary",size:"small"}),label:"Tên"}),e.jsx(te,{value:"1",control:e.jsx(ae,{color:"secondary",size:"small"}),label:"Mã"})]})})})]}),he?e.jsx(N,{children:"Đang tải dữ liệu..."}):e.jsx(ne,{component:G,style:{marginTop:"16px"},children:e.jsxs(se,{children:[e.jsx(oe,{children:e.jsxs(b,{children:[e.jsx(n,{sx:{textAlign:"center"},children:"Mã sản phẩm"}),e.jsx(n,{sx:{textAlign:"center"},children:"Tên sản phẩm"}),e.jsx(n,{sx:{textAlign:"center"},children:"Trạng Thái"}),e.jsx(n,{sx:{textAlign:"center"},children:"Chọn"})]})}),e.jsx(le,{children:P.length>0?P.map(t=>e.jsxs(b,{children:[e.jsx(n,{sx:{textAlign:"center"},children:t.ma}),e.jsx(n,{sx:{textAlign:"center"},children:t.ten}),e.jsx(n,{sx:{textAlign:"center"},children:e.jsx(y,{sx:{backgroundColor:t.trangThai===1?"#4caf50":"#f44336",color:"#ffffff",padding:"6px 12px",borderRadius:"12px",textAlign:"center",fontWeight:"bold"},children:t.trangThai===1?"Hoạt động":"Đã tắt"})}),e.jsx(n,{sx:{textAlign:"center"},children:e.jsx(ce,{checked:g.includes(t.id),onChange:()=>Te(t.id),disabled:d})})]},t.id)):e.jsx(b,{children:e.jsx(n,{colSpan:4,children:e.jsx(N,{variant:"body2",color:"textSecondary",align:"center",children:"Không có sản phẩm nào"})})})})]})}),e.jsx(y,{display:"fixed",justifyContent:"center",alignItems:"center",marginTop:2,children:e.jsx(ze,{count:ge,page:C,onChange:xe,color:"primary"})})]}),e.jsxs(Oe,{color:"primary","aria-label":"back",sx:{position:"fixed",bottom:16,right:16},onClick:fe,children:[e.jsx(Le,{})," "]})]}),e.jsxs(y,{sx:{marginTop:4},children:[e.jsx(Ke,{value:V,onChange:ye,children:g.map(t=>{const a=P.find(r=>r.id===t);return e.jsx(Me,{label:a?`${a.ten}`:`Sản phẩm ${t}`},t)})}),g.map(t=>{var a;return V===g.indexOf(t)&&e.jsx(y,{sx:{marginTop:2},children:e.jsx(ne,{component:G,children:e.jsxs(se,{children:[e.jsx(oe,{children:e.jsxs(b,{children:[e.jsx(n,{children:"Chọn"}),e.jsx(n,{children:"Giá bán"}),e.jsx(n,{children:"Bàn phím"}),e.jsx(n,{children:"CPU"}),e.jsx(n,{children:"Hệ điều hành"}),e.jsx(n,{children:"Màn hình"}),e.jsx(n,{children:"Màu sắc"}),e.jsx(n,{children:"RAM"}),e.jsx(n,{children:"VGA"}),e.jsx(n,{children:"Webcam"}),e.jsx(n,{children:"Trạng thái"})]})}),e.jsx(le,{children:(a=W[t])==null?void 0:a.map(r=>{var s;return e.jsxs(b,{children:[e.jsx(n,{children:e.jsx(ce,{checked:((s=z[t])==null?void 0:s.includes(r.id))||!1,onChange:()=>je(t,r),disabled:d})}),e.jsx(n,{children:r.giaBan}),e.jsx(n,{children:r.banPhim}),e.jsx(n,{children:r.cpu}),e.jsx(n,{children:r.heDieuHanh}),e.jsx(n,{children:r.manHinh}),e.jsx(n,{children:r.mauSac}),e.jsx(n,{children:r.ram}),e.jsx(n,{children:r.vga}),e.jsx(n,{children:r.webcam}),e.jsxs(n,{children:[" ",e.jsx(y,{sx:{display:"inline-block",padding:"4px 8px",borderRadius:"8px",backgroundColor:r.trangThai===0?"error.light":"success.light",color:r.trangThai===0?"error.dark":"success.dark",fontWeight:"bold"},children:r.trangThai===0?"Không hoạt động":"Hoạt động"})]})]},r.id)})})]})})},t)})]}),e.jsx(Ve,{open:S.open,autoHideDuration:6e3,onClose:Z,anchorOrigin:{vertical:"top",horizontal:"right"},children:e.jsx(_e,{onClose:Z,severity:S.severity,sx:{width:"100%"},children:S.message})}),e.jsxs(Xe,{open:me,onClose:()=>A(!1),children:[e.jsx(Qe,{children:"Xác nhận"}),e.jsx(Ue,{children:e.jsx(Ye,{children:"Bạn có chắc chắn muốn lưu thông tin phiếu giảm giá này?"})}),e.jsxs(Je,{children:[e.jsx(L,{onClick:()=>A(!1),color:"primary",children:"Hủy"}),e.jsx(L,{onClick:()=>A(!0),color:"primary",autoFocus:!0,children:"Xác nhận"})]})]})]})}export{ft as default};

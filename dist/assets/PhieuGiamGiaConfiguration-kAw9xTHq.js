import{r as t,a as ke,b as Se,c as L,j as e,G as r,d as J,T as N,e as Pe,f as h,I as Q,h as U,F as K,i as w,B as Y,k as Z,D as ve,m as De,A as Ge}from"./index-lZI9Axgt.js";import{B as c,u as Le,d as Ne}from"./bignumber-DtsjB1fK.js";import{d as Ke}from"./AttachMoney-Cam5D-0A.js";import{c as we,a as H,b as He,d as ee,e as Ie}from"./index.esm-geAfmb5E.js";import{g as Be,a as We,b as ne}from"./customerService-DRgDxwje.js";import{d as $e}from"./ArrowBack-pRIo-mOp.js";import{R as Ae,a as ae}from"./RadioGroup-Dd5T_W4C.js";import{F as ie}from"./FormControlLabel-BBO_n_LH.js";import{M as f}from"./MenuItem-Divc6vnu.js";import{F as Ee}from"./Fab-CuekNszq.js";import{T as qe,a as Oe,b as Fe,c as re,d as Ve}from"./TableRow-D7eToa8r.js";import{T as u}from"./TableCell-jiXaIEqu.js";import{C as te}from"./Checkbox-xHV0VMdW.js";import{P as Re}from"./Pagination-FwOutBp-.js";import{S as Me}from"./Snackbar-DKwmTxl_.js";import{D as ze,a as _e,b as Xe,c as Je}from"./DialogTitle-Bl5CTXqr.js";import{D as Qe}from"./DialogContentText-BzFOanTg.js";import"./request-ClRr-5Ll.js";import"./SwitchBase-I1IR-Hvy.js";import"./LastPage-CPU0u6Bk.js";function Tn(){const[g,I]=t.useState("%"),[k,B]=t.useState([]),[o,T]=t.useState([]),[m,W]=t.useState(1),[se,oe]=t.useState(0),[Ue,$]=t.useState(!1),{id:y}=ke(),A=Se();t.useState(null);const[b,d]=t.useState({open:!1,message:"",severity:"success"}),[le,E]=t.useState(!1),[S,he]=t.useState(!1),[p,q]=t.useState(""),[x,ce]=t.useState(""),[ue,P]=t.useState(!1),ge=we({tenPhieu:H().required("Tên phiếu giảm giá là bắt buộc"),giaTri:H().required("Giá trị là bắt buộc").test("is-valid-value",(n,i)=>{if(!n)return i.createError({message:"Giá trị là bắt buộc"});const s=new c(n.replace(/\./g,""));if(g==="%"){if(!s.isGreaterThan(0))return i.createError({message:"Giá trị phải lớn hơn 0%"});if(!s.isLessThanOrEqualTo(100))return i.createError({message:"Giá trị không được vượt quá 100%"});if(!s.isLessThanOrEqualTo(2e6))return i.createError({message:"Giá trị giảm không được vượt quá 2,000,000"})}else if(g==="$"){if(!s.isGreaterThan(0))return i.createError({message:"Giá trị phải lớn hơn 0$"});if(!s.isLessThanOrEqualTo(2e6))return i.createError({message:"Giá trị giảm không được vượt quá 2,000,000"})}else return i.createError({message:"Loại phiếu không hợp lệ"});return!0}),soLuong:He().required("Số lượng là bắt buộc").positive("Số lượng phải lớn hơn 0").integer("Số lượng phải là số nguyên"),dieuKien:H().required("Điều kiện là bắt buộc").test("is-big-decimal","Điều kiện phải lớn hơn 10",n=>n?new c(n.replace(/\./g,"")).isGreaterThan(10):!1),tuNgay:ee().min(new Date,"Từ ngày phải là ngày trong tương lai").required("Từ ngày là bắt buộc"),denNgay:ee().min(Ie("tuNgay"),"Đến ngày phải sau từ ngày").required("Đến ngày là bắt buộc")});t.useEffect(()=>{debugger;de()},[m,p,x,y]);const de=async()=>{$(!0);try{let n;p&&x==""?n=await Be(m-1,p):x!==""&&p==""?n=await We(m-1,x):x==""&&p==""&&(n=await ne(m-1)),B(n.content),oe(n.totalPages)}catch(n){console.error(n)}finally{$(!1)}};t.useEffect(()=>{me(),be()},[y]);const me=async()=>{try{const n=await ne(m-1);B(n.content)}catch(n){console.error(n)}},pe=n=>{const i=n.target.value;ce(i),W(1),q("")},xe=()=>{A("/phieugiamgia/danhsachphieugiamgia")};t.useEffect(()=>{console.log("Danh sách khách hàng đã chọn:",o)},[]),t.useEffect(()=>{o.length>a.values.soLuong&&(a.setFieldValue("soLuong",o.length),d({open:!0,message:`Số lượng khách hàng đã chọn (${o.length}) nhiều hơn số lượng phiếu đã nhập, số lượng phiếu đã được tự động điều chỉnh.`,severity:"info"}))},[o]);const a=Le({initialValues:{tenPhieu:"",giaTri:"",giaTriToiDa:"",soLuong:"",dieuKien:"",tuNgay:"",denNgay:"",kieu:"1"},validationSchema:ge,onSubmit:async(n,{setErrors:i,validateForm:s})=>{var z,_;const j=await s();if(Object.keys(j).length>0){i(j);return}try{if(P(!0),n.kieu==="2"&&o.length>n.soLuong){d({open:!0,message:`Số lượng khách hàng được chọn (${o.length}) nhiều hơn số lượng phiếu (${n.soLuong}). Vui lòng tăng số lượng phiếu.`,severity:"error"});return}if(n.kieu==="2"&&o.length<1){d({open:!0,message:"Vui lòng chọn khách hàng cho phiếu giảm giá.",severity:"error"});return}const D=new c(String(n.giaTri).replace(/\./g,"")),G=n.giaTriToiDa===""||n.giaTriToiDa==null?new c(0):new c(String(n.giaTriToiDa).replace(/\./g,""));if(n.giaTriToiDa==null||n.giaTriToiDa===""){i({giaTriToiDa:"Giá trị tối đa không được để trống."});return}if(g==="$"&&!G.isEqualTo(D)){i({giaTriToiDa:"Giá trị tối đa phải bằng với giá trị giảm giá khi loại chiết khấu là tiền."});return}if(g==="%"&&!G.isLessThanOrEqualTo(2e6)){i({giaTriToiDa:"Giá trị giảm không được vượt quá 2,000,000."});return}const C={ten:n.tenPhieu,giaTriDonToiThieu:new c(String(n.dieuKien).replace(/\./g,"")).toFixed(),ngayBatDau:V(n.tuNgay),ngayHetHan:V(n.denNgay),loaiGiamGia:g==="%"?1:2,giaTriGiamGia:new c(String(n.giaTri).replace(/\./g,"")).toFixed(),giamToiDa:n.giaTriToiDa===""?null:new c(String(n.giaTriToiDa).replace(/\./g,"")).toFixed(),phamViApDung:n.kieu,soLuong:n.soLuong,listKhachHang:o};let X;y?(X=await L.put(`http://localhost:8080/api/coupons/update/${y}`,C),d({open:!0,message:"Phiếu giảm giá đã được cập nhật thành công!",severity:"success"})):(X=await L.post("http://localhost:8080/api/coupons/add",C),d({open:!0,message:"Phiếu giảm giá đã được tạo thành công!",severity:"success"})),setTimeout(()=>{A("/phieugiamgia/danhsachphieugiamgia")},3e3)}catch(D){const C=(((_=(z=D.response)==null?void 0:z.data)==null?void 0:_.error)||"Đã xảy ra lỗi!").split(":")[1].split(":")[0].trim();d({open:!0,message:`Lỗi: ${C}`,severity:"error"})}finally{P(!1)}}}),O=n=>{I(n)},fe=n=>{T(i=>{const s=Array.isArray(i)&&i.includes(n)?i.filter(j=>j!==n):[...Array.isArray(i)?i:[],n];return console.log("Selected KhachHang within handler:",s),s})},F=n=>[{id:0,name:"Chưa áp dụng",color:"gray"},{id:1,name:"Đang áp dụng",color:"green"},{id:2,name:"Đã hết hạn",color:"red"},{id:3,name:"Đã hủy",color:"orange"}].find(s=>s.id===n)||{name:"Không xác định",color:"default"},ye=(n,i)=>{W(i)},Te=n=>{const i={year:"numeric",month:"2-digit",day:"2-digit"};return new Date(n).toLocaleDateString("vi-VN",i)};function V(n){return n?n.length===16?`${n}:00`:(n.length===19,n):""}const R=()=>{d({...b,open:!1}),P(!1)},be=async()=>{try{debugger;const i=(await L.get(`http://localhost:8080/api/coupons/detail/${y}`)).data;a.setValues({stat:i.data.trangThai,maPhieu:i.data.ma,tenPhieu:i.data.ten,giaTri:i.data.giaTriGiamGia,giaTriToiDa:i.data.giamToiDa,soLuong:i.data.soLuong,dieuKien:i.data.giaTriDonToiThieu,tuNgay:i.data.ngayBatDau,denNgay:i.data.ngayHetHan,kieu:i.data.phamViApDung.toString()}),I(i.data.loaiGiamGia===1?"%":"$");const s=i.data.khachHangPhieuGiamGias||[];T(s)}catch(n){console.error("Error fetching coupon detail:",n)}},l=location.pathname.includes("/phieugiamgia/chitietphieugiamgia"),je=()=>{E(!0)},v=n=>{E(!1),n&&a.handleSubmit()};function M(n){return String(n||"").replace(/\D/g,"").replace(/\B(?=(\d{3})+(?!\d))/g,".")}const Ce=()=>{T(S?[]:k.map(n=>n.id)),he(!S)};return e.jsxs(r,{container:!0,spacing:2,children:[e.jsx(r,{item:!0,xs:6,children:e.jsxs(J,{style:{padding:"16px",height:"100%"},children:[l&&e.jsxs(r,{item:!0,xs:12,sx:{mb:2},children:[e.jsx(N,{variant:"h6",children:"Trạng thái phiếu:"}),e.jsx(Pe,{label:F(a.values.stat).name,sx:{backgroundColor:F(a.values.stat).color,color:"white",fontWeight:"bold"}})]}),e.jsxs("form",{onSubmit:a.handleSubmit,children:[e.jsx(h,{label:"Mã Phiếu Giảm Giá",name:"maPhieu",fullWidth:!1,margin:"normal",value:a.values.maPhieu,onChange:a.handleChange,error:a.touched.maPhieu&&!!a.errors.maPhieu,helperText:a.touched.maPhieu&&a.errors.maPhieu,InputProps:{readOnly:!0,inputProps:{tabIndex:-1},sx:{pointerEvents:"none",backgroundColor:"rgba(0, 0, 0, 0.04)"}},InputLabelProps:{shrink:!0},sx:{width:"200px"}}),e.jsx(h,{label:"Tên Phiếu Giảm Giá",name:"tenPhieu",fullWidth:!0,margin:"normal",InputProps:{readOnly:l},value:a.values.tenPhieu,onChange:a.handleChange,error:a.touched.tenPhieu&&!!a.errors.tenPhieu,helperText:a.touched.tenPhieu&&a.errors.tenPhieu}),e.jsxs(r,{container:!0,spacing:2,children:[e.jsx(r,{item:!0,xs:6,children:e.jsx(h,{label:"Giá trị giảm giá",name:"giaTri",fullWidth:!0,margin:"normal",value:a.values.giaTri,onChange:a.handleChange,error:a.touched.giaTri&&!!a.errors.giaTri,helperText:a.touched.giaTri&&a.errors.giaTri,InputProps:{readOnly:l,endAdornment:e.jsxs(Q,{position:"end",children:[e.jsx(U,{onClick:()=>{l||O("%")},color:g==="%"?"primary":"default",children:e.jsx(Ne,{})}),e.jsx(U,{onClick:()=>{l||O("$")},color:g==="$"?"primary":"default",children:e.jsx(Ke,{})})]})}})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(h,{label:" Giá trị giảm giá tối đa",name:"giaTriToiDa",fullWidth:!0,margin:"normal",value:M(a.values.giaTriToiDa),onChange:a.handleChange,error:a.touched.giaTriToiDa&&!!a.errors.giaTriToiDa,helperText:a.touched.giaTriToiDa&&a.errors.giaTriToiDa,InputProps:{readOnly:l,endAdornment:e.jsx(Q,{position:"end",children:e.jsx(N,{sx:{color:"orange",fontWeight:"bold"},children:"₫"})})}})})]}),e.jsxs(r,{container:!0,spacing:2,children:[e.jsx(r,{item:!0,xs:6,children:e.jsx(h,{label:"Số lượng",value:a.values.soLuong,onChange:a.handleChange,variant:"outlined",fullWidth:!0,margin:"normal",name:"soLuong",helperText:a.touched.soLuong&&a.errors.soLuong?a.errors.soLuong:"",error:a.touched.soLuong&&!!a.errors.soLuong})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(h,{label:"Giá trị đơn tối thiểu",name:"dieuKien",fullWidth:!0,margin:"normal",InputProps:{readOnly:l},value:M(a.values.dieuKien),onChange:a.handleChange,error:a.touched.dieuKien&&!!a.errors.dieuKien,helperText:a.touched.dieuKien&&a.errors.dieuKien})})]}),e.jsxs(r,{container:!0,spacing:2,children:[e.jsx(r,{item:!0,xs:6,children:e.jsx(h,{label:"Từ ngày",name:"tuNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:l},value:a.values.tuNgay,onChange:a.handleChange,InputLabelProps:{shrink:!0},error:a.touched.tuNgay&&!!a.errors.tuNgay,helperText:a.touched.tuNgay&&a.errors.tuNgay})}),e.jsx(r,{item:!0,xs:6,children:e.jsx(h,{label:"Đến ngày",name:"denNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:l},value:a.values.denNgay,InputLabelProps:{shrink:!0},onChange:a.handleChange,error:a.touched.denNgay&&!!a.errors.denNgay,helperText:a.touched.denNgay&&a.errors.denNgay})})]}),e.jsxs(r,{container:!0,justifyContent:"flex-start",alignItems:"center",spacing:2,children:[e.jsx(r,{item:!0,children:e.jsx(K,{component:"legend",children:"Phạm vi áp dụng"})}),e.jsx(r,{item:!0,children:e.jsxs(Ae,{row:!0,"aria-label":"phạm vi áp dụng",name:"kieu",value:a.values.kieu,onChange:n=>{l||a.handleChange(n)},children:[e.jsx(ie,{value:"1",control:e.jsx(ae,{}),label:"Công khai"}),e.jsx(ie,{value:"2",control:e.jsx(ae,{}),label:"Cá nhân hóa"})]})})]}),!l&&e.jsx(w,{fullWidth:!0,variant:"contained",sx:{mt:2},onClick:je,disabled:ue,children:"Lưu"})]})]})}),e.jsx(r,{item:!0,xs:6,children:e.jsxs(J,{style:{padding:"16px",height:"100%"},children:[e.jsx(N,{variant:"h6",gutterBottom:!0,children:"Chọn khách hàng"}),e.jsx(Y,{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",mb:2,p:2,sx:{backgroundColor:"white",boxShadow:"0 4px 8px rgba(0, 0, 0, 0.1)",borderRadius:"8px",width:"100%"},children:e.jsxs(r,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(r,{item:!0,xs:5,children:e.jsxs(Z,{fullWidth:!0,children:[e.jsx(K,{component:"legend",sx:{mb:1,fontWeight:"bold",fontSize:"1rem",color:"text.primary"},children:"Tìm kiếm"}),e.jsx(h,{value:p,onChange:n=>q(n.target.value),variant:"outlined",placeholder:"Nhập tên khách hàng",fullWidth:!0,InputProps:{style:{borderRadius:"8px"}}})]})}),e.jsx(ve,{orientation:"vertical",flexItem:!0,sx:{mx:2}}),e.jsx(r,{item:!0,xs:5,children:e.jsxs(Z,{fullWidth:!0,children:[e.jsx(K,{component:"legend",sx:{mb:1,fontWeight:"bold",fontSize:"1rem",color:"text.primary"},children:"Hạng khách hàng"}),e.jsxs(De,{labelId:"hang-khach-hang-label",id:"hang-khach-hang-select",value:x,onChange:pe,displayEmpty:!0,fullWidth:!0,sx:{borderRadius:"8px",backgroundColor:"white"},children:[e.jsx(f,{value:"",children:"-- Tất cả khách hàng --"}),e.jsx(f,{value:0,children:"Đồng"}),e.jsx(f,{value:1,children:"Bạc"}),e.jsx(f,{value:2,children:"Vàng"}),e.jsx(f,{value:3,children:"Bạch Kim"}),e.jsx(f,{value:4,children:"Kim Cương"})]})]})}),e.jsx(Ee,{color:"primary","aria-label":"back",sx:{position:"fixed",bottom:16,right:16},onClick:xe,children:e.jsx($e,{})})]})}),e.jsx(qe,{children:e.jsxs(Oe,{children:[e.jsx(Fe,{children:e.jsxs(re,{children:[e.jsx(u,{padding:"checkbox",children:e.jsx(te,{indeterminate:o.length>0&&o.length<k.length,checked:S,onChange:Ce,disabled:l||a.values.kieu==="1"})}),e.jsx(u,{children:"Tên khách hàng"}),e.jsx(u,{children:"Số điện thoại"}),e.jsx(u,{children:"Ngày sinh"})]})}),e.jsx(Ve,{children:k.map(n=>e.jsxs(re,{children:[e.jsx(u,{padding:"checkbox",children:e.jsx(te,{checked:Array.isArray(o)&&o.includes(n.id),onChange:()=>fe(n.id),disabled:l||a.values.kieu==="1"})}),e.jsx(u,{children:n.ten}),e.jsx(u,{children:n.sdt}),e.jsx(u,{children:Te(n.ngaySinh)})]},n.id))})]})}),e.jsx(Y,{display:"fixed",justifyContent:"center",alignItems:"center",marginTop:2,children:e.jsx(Re,{count:se,page:m,onChange:ye,color:"primary"})})]})}),e.jsx(Me,{open:b.open,autoHideDuration:6e3,onClose:R,anchorOrigin:{vertical:"top",horizontal:"right"},children:e.jsx(Ge,{onClose:R,severity:b.severity,sx:{width:"100%"},children:b.message})}),e.jsxs(ze,{open:le,onClose:()=>v(!1),children:[e.jsx(_e,{children:"Xác nhận"}),e.jsx(Xe,{children:e.jsx(Qe,{children:"Bạn có chắc chắn muốn lưu thông tin phiếu giảm giá này?"})}),e.jsxs(Je,{children:[e.jsx(w,{onClick:()=>v(!1),color:"primary",children:"Hủy"}),e.jsx(w,{onClick:()=>v(!0),color:"primary",autoFocus:!0,children:"Xác nhận"})]})]})]})}export{Tn as default};

import{r as o,aa as Pe,a4 as we,bc as $e,ab as b,j as e,G as A,V as v,N as d,z as Y,I,T as N,Z as E,ac as Be,J as Ae,a6 as Ee,a7 as ee,a8 as ae,B as j,a9 as Le}from"./index-COCf9D-9.js";import{B as k,d as Oe,a as Fe,b as We}from"./ArrowBack-Dcp2cUk7.js";import{c as qe,a as L,d as te}from"./index.esm-krW_ShVY.js";import{u as He}from"./formik.esm-g0EOOUin.js";import{g as Re,b as re}from"./dotGiamGiaService-BCoPb-e4.js";import{T as ne,a as ie,b as se,c as y,d as oe}from"./TableRow-BjFi84E7.js";import{T as i}from"./TableCell-DFzCksj9.js";import{C as le}from"./Checkbox-BaIBsI-F.js";import{P as Ve}from"./Pagination-p0ct8pHs.js";import{T as ze,a as Ke}from"./Tabs-DiJb2MiR.js";import{S as Me,A as _e}from"./Snackbar-DdnTY-uA.js";import{a as Xe,c as Je,b as Qe,D as Ue}from"./DialogTitle-C9lArIW3.js";import{D as Ze}from"./DialogContentText-BudPzXZW.js";import"./LastPage-DEWP3WKD.js";import"./KeyboardArrowRight-DZPhPuW4.js";import"./Close-G1yeCTF0.js";function xa(){const[O,F]=o.useState({}),[G,W]=o.useState([]),[u,q]=o.useState([]),[H,R]=o.useState({}),[ce,V]=o.useState(!1),[z,he]=o.useState(0),{id:x}=Pe(),K=we(),M=$e(),[T,g]=o.useState({open:!1,message:"",severity:"success"}),[Ye,_]=o.useState(!1),[h,X]=o.useState(!1),[m,P]=o.useState("%"),[S,de]=o.useState(1),[ue,ge]=o.useState(1),[w,Ie]=o.useState(5),[pe,J]=o.useState(!1);o.useEffect(()=>{Q(S,w)},[S,w]),o.useEffect(()=>{M.pathname.includes("/dotgiamgia/cauhinhdotgiamgia/view")?X(!0):X(!1)},[M,x]),o.useEffect(()=>{const a=async()=>{debugger;try{const t=await Promise.all(u.map(async r=>{const s=await re(r);return{sanPhamId:r,productDetails:s.data.data}}));F(r=>{const s={...r};return t.forEach(({sanPhamId:l,productDetails:f})=>{s[l]=f}),s})}catch{g({open:!0,message:"không thể tìm được sản phẩm chi tiết",severity:"error"})}};u.length>0&&a()},[u]),o.useEffect(()=>{Se(),Q(S,w)},[x]);const Q=async(a,t)=>{V(!0);try{const r=await Re(a-1,t);W(r.data||[]),ge(r.totalPage||1)}catch(r){console.error("Lỗi khi tải dữ liệu sản phẩm:",r),g({open:!0,message:"Lỗi khi tải dữ liệu sản phẩm",severity:"error"})}finally{V(!1)}},me=(a,t)=>{de(t)},xe=()=>{K("/dotgiamgia/danhsachdotgiamgia")},fe=async a=>{debugger;q(t=>{const r=t.includes(a)?t.filter(s=>s!==a):[...t,a];return O[a]||(async()=>{try{const l=(await re(a)).data.data;F(f=>({...f,[a]:l}))}catch{g({open:!0,message:"Lỗi khi tải sản phẩm chi tiết",severity:"error"})}})(),r})},be=(a,t)=>{debugger;R(r=>{const s=r[a]||[];return s.includes(t.id)?{...r,[a]:s.filter(l=>l!==t.id)}:{...r,[a]:[...s,t.id]}})},je=(a,t)=>{he(t)};function ye(a){return String(a||"").replace(/\D/g,"").replace(/\B(?=(\d{3})+(?!\d))/g,".")}function U(a){return a?a.length===16?`${a}:00`:(a.length===19,a):""}const n=He({initialValues:{tenPhieu:"",giaTri:"",giaTriToiDa:"",tuNgay:"",denNgay:"",loaiChietKhau:"1"},validationSchema:qe({tenPhieu:L().required("Tên đợt giảm giá là bắt buộc"),giaTri:L().required("Giá trị là bắt buộc").test("is-valid-value",(a,t)=>{if(!a)return t.createError({message:"Giá trị là bắt buộc"});const r=new k(a.replace(/\./g,""));if(m==="%"){if(!r.isGreaterThan(0))return t.createError({message:"Giá trị phải lớn hơn 0%"});if(!r.isLessThanOrEqualTo(100))return t.createError({message:"Giá trị không được vượt quá 100%"})}else if(m==="$"){if(!r.isGreaterThan(0))return t.createError({message:"Giá trị phải lớn hơn 0$"})}else return t.createError({message:"Loại phiếu không hợp lệ"});return!0}),giaTriToiDa:L().required("Giá trị tối đa là bắt buộc").test("is-big-decimal","Giá trị phải lớn hơn 0",a=>a?new k(a.replace(/\./g,"")).isGreaterThan(0):!1).test("is-giamToiDa-equal-giaTri","Giá trị tối đa phải bằng giá trị khi loại giảm giá là $",function(a){const{giaTri:t}=this.parent;if(m==="$"){const r=new k(a.replace(/\./g,"")),s=new k(t.replace(/\./g,""));return r.isEqualTo(s)}return!0}),tuNgay:te().required("Ngày bắt đầu là bắt buộc").min(new Date,"Ngày bắt đầu phải từ hiện tại trở đi"),denNgay:te().required("Ngày kết thúc là bắt buộc").when("tuNgay",(a,t)=>t.min(a,"Ngày kết thúc phải sau ngày bắt đầu"))}),onSubmit:async a=>{try{_(!0);const t=Object.values(H).flat(),r={ten:a.tenPhieu,moTa:a.moTa,giaTriGiam:a.giaTri,giamToiDa:a.giaTriToiDa,loaiChietKhau:m==="%"?1:2,thoiGianBatDau:U(a.tuNgay),thoiGianKetThuc:U(a.denNgay),listSanPhamChiTiet:t};let s;x?(s=await b.put(`http://localhost:8080/api/v1/discounts/update/${x}`,r),g({open:!0,message:"Đợt giảm giá đã được cập nhật thành công!",severity:"success"})):(s=await b.post("http://localhost:8080/api/v1/discounts/add",r),g({open:!0,message:"Đợt giảm giá đã được tạo thành công!",severity:"success"})),setTimeout(()=>{K("/dotgiamgia/danhsachdotgiamgia")},3e3)}catch(t){console.log(t),g({open:!0,message:"Đã xảy ra lỗi!",severity:"error"})}}}),$=a=>{J(!1),a&&n.handleSubmit()},Z=()=>{g({...T,open:!1}),_(!1)},Te=()=>{J(!0)},Se=async()=>{try{debugger;const t=(await b.get(`http://localhost:8080/api/v1/discounts/${x}`)).data;n.setValues({stat:t.trangThai,maPhieu:t.ma,tenPhieu:t.ten,moTa:t.moTa,giaTri:t.giaTriGiam,tuNgay:t.thoiGianBatDau,denNgay:t.thoiGianKetthuc,giaTriToiDa:t.giamToiDa}),P(t.loaiChietKhau===1?"%":"$");const r=t.spctDotGiamGias||[],s=await Promise.all(r.map(async c=>(await b.get(`http://localhost:8080/api/san-pham-chi-tiet/get-by-productdetail-id?idProductDetail=${c}`)).data.data)),l=s.map(c=>parseInt(c.sanPhamId)).filter((c,p,Ge)=>!isNaN(c)&&Ge.indexOf(c)===p),f=s.reduce((c,p)=>(c[p.sanPhamId]||(c[p.sanPhamId]=[]),c[p.sanPhamId].push(p.id),c),{});q(l),R(f)}catch(a){console.error("Error fetching DGG detail:",a)}},[B,Ce]=o.useState("0"),De=a=>{const t=a.target.value.toString().trim();B==="0"?D(r=>({...r,tenSanPham:t,ma:""})):B==="1"&&D(r=>({...r,ma:t,tenSanPham:""}))},ve=a=>{const t=a.target.value;Ce(t),t==="0"?D(r=>({...r,tenSanPham:C.ma,ma:""})):t==="1"&&D(r=>({...r,ma:C.tenSanPham,tenSanPham:""}))};o.useState(0);const Ne="http://localhost:8080/api/san-pham/find/filter-id?",[C,D]=o.useState({page:0,size:"5",tenSanPham:"",ma:"",trangThai:1});o.useEffect(()=>{ke()},[C]);const ke=async()=>{const a=Object.entries(C).filter(([s,l])=>l!=="").map(([s,l])=>`${s}=${l}`).join("&"),t=Ne+a,r=await b.get(t);W(r.data.data),setTotalElement(parseInt(r.data.totalElement))};return e.jsxs(A,{container:!0,spacing:2,children:[e.jsx(A,{item:!0,xs:4,children:e.jsx(v,{style:{padding:"16px",height:"100%"},children:e.jsxs("form",{onSubmit:n.handleSubmit,children:[e.jsx(d,{label:"Mã Đợt Giảm Giá",name:"maPhieu",fullWidth:!0,margin:"normal",value:n.values.maPhieu,onChange:n.handleChange,InputProps:{readOnly:!0},InputLabelProps:{shrink:!0}}),e.jsx(d,{label:"Tên Đợt Giảm Giá",name:"tenPhieu",fullWidth:!0,margin:"normal",value:n.values.tenPhieu,onChange:n.handleChange,error:n.touched.tenPhieu&&!!n.errors.tenPhieu,helperText:n.touched.tenPhieu&&n.errors.tenPhieu}),e.jsx(d,{label:"Giá trị phiếu",name:"giaTri",fullWidth:!0,margin:"normal",value:n.values.giaTri,onChange:n.handleChange,error:n.touched.giaTri&&!!n.errors.giaTri,helperText:n.touched.giaTri&&n.errors.giaTri,InputProps:{readOnly:h,endAdornment:e.jsxs(Y,{position:"end",children:[e.jsx(I,{onClick:()=>!h&&P("%"),color:m==="%"?"primary":"default",children:e.jsx(Oe,{})}),e.jsx(I,{onClick:()=>!h&&P("$"),color:m==="$"?"primary":"default",children:e.jsx(Fe,{})})]})}}),e.jsx(d,{label:" Giá trị giảm giá tối đa",name:"giaTriToiDa",fullWidth:!0,margin:"normal",value:ye(n.values.giaTriToiDa),onChange:n.handleChange,error:n.touched.giaTriToiDa&&!!n.errors.giaTriToiDa,helperText:n.touched.giaTriToiDa&&n.errors.giaTriToiDa,InputProps:{readOnly:h,endAdornment:e.jsx(Y,{position:"end",children:e.jsx(N,{sx:{color:"orange",fontWeight:"bold"},children:"₫"})})}}),e.jsx(d,{label:"Từ ngày",name:"tuNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:h},value:n.values.tuNgay,onChange:n.handleChange,InputLabelProps:{shrink:!0},error:n.touched.tuNgay&&!!n.errors.tuNgay,helperText:n.touched.tuNgay&&n.errors.tuNgay}),e.jsx(d,{label:"Đến ngày",name:"denNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:h},value:n.values.denNgay,onChange:n.handleChange,InputLabelProps:{shrink:!0},error:n.touched.denNgay&&!!n.errors.denNgay,helperText:n.touched.denNgay&&n.errors.denNgay}),e.jsx(d,{label:"Mô tả đợt giảm giá",name:"moTa",fullWidth:!0,margin:"normal",value:n.values.moTa,InputLabelProps:{shrink:!0},onChange:n.handleChange,error:n.touched.moTa&&!!n.errors.moTa,helperText:n.touched.moTa&&n.errors.moTa,sx:{fontFamily:"Arial, sans-serif"}}),!h&&e.jsx(E,{fullWidth:!0,variant:"contained",sx:{mt:2},onClick:Te,children:"Lưu"})]})})}),e.jsxs(A,{item:!0,xs:8,children:[e.jsxs(v,{style:{padding:"16px",height:"100%"},children:[e.jsx(N,{variant:"h6",children:"Danh sách sản phẩm"}),e.jsx(Be,{}),e.jsxs("div",{style:{display:"flex",padding:10,paddingTop:20},children:[e.jsx(d,{sx:{maxHeight:"10px"},color:"secondary",onChange:De,id:"outlined-basic",label:"Nhập từ khóa",variant:"outlined"}),e.jsx("div",{style:{marginLeft:10,display:"flex",alignItems:"center"},children:e.jsx(Ae,{children:e.jsxs(Ee,{"aria-labelledby":"demo-controlled-radio-buttons-group",name:"controlled-radio-buttons-group",value:B,row:!0,onChange:ve,children:[e.jsx(ee,{value:"0",control:e.jsx(ae,{color:"secondary",size:"small"}),label:"Tên"}),e.jsx(ee,{value:"1",control:e.jsx(ae,{color:"secondary",size:"small"}),label:"Mã"})]})})})]}),ce?e.jsx(N,{children:"Đang tải dữ liệu..."}):e.jsx(ne,{component:v,style:{marginTop:"16px"},children:e.jsxs(ie,{children:[e.jsx(se,{children:e.jsxs(y,{children:[e.jsx(i,{sx:{textAlign:"center"},children:"Mã sản phẩm"}),e.jsx(i,{sx:{textAlign:"center"},children:"Tên sản phẩm"}),e.jsx(i,{sx:{textAlign:"center"},children:"Trạng Thái"}),e.jsx(i,{sx:{textAlign:"center"},children:"Chọn"})]})}),e.jsx(oe,{children:G.length>0?G.map(a=>e.jsxs(y,{children:[e.jsx(i,{sx:{textAlign:"center"},children:a.ma}),e.jsx(i,{sx:{textAlign:"center"},children:a.ten}),e.jsx(i,{sx:{textAlign:"center"},children:e.jsx(j,{sx:{backgroundColor:a.trangThai===1?"#4caf50":"#f44336",color:"#ffffff",padding:"6px 12px",borderRadius:"12px",textAlign:"center",fontWeight:"bold"},children:a.trangThai===1?"Hoạt động":"Đã tắt"})}),e.jsx(i,{sx:{textAlign:"center"},children:e.jsx(le,{checked:u.includes(a.id),onChange:()=>fe(a.id),disabled:h})})]},a.id)):e.jsx(y,{children:e.jsx(i,{colSpan:4,children:e.jsx(N,{variant:"body2",color:"textSecondary",align:"center",children:"Không có sản phẩm nào"})})})})]})}),e.jsx(j,{display:"fixed",justifyContent:"center",alignItems:"center",marginTop:2,children:e.jsx(Ve,{count:ue,page:S,onChange:me,color:"primary"})})]}),e.jsxs(Le,{color:"primary","aria-label":"back",sx:{position:"fixed",bottom:16,right:16},onClick:xe,children:[e.jsx(We,{}),"  "]})]}),e.jsxs(j,{sx:{marginTop:4},children:[e.jsx(ze,{value:z,onChange:je,children:u.map(a=>{const t=G.find(r=>r.id===a);return e.jsx(Ke,{label:t?`${t.ten}`:`Sản phẩm ${a}`},a)})}),u.map(a=>{var t;return z===u.indexOf(a)&&e.jsx(j,{sx:{marginTop:2},children:e.jsx(ne,{component:v,children:e.jsxs(ie,{children:[e.jsx(se,{children:e.jsxs(y,{children:[e.jsx(i,{children:"Chọn"}),e.jsx(i,{children:"Giá bán"}),e.jsx(i,{children:"Bàn phím"}),e.jsx(i,{children:"CPU"}),e.jsx(i,{children:"Hệ điều hành"}),e.jsx(i,{children:"Màn hình"}),e.jsx(i,{children:"Màu sắc"}),e.jsx(i,{children:"RAM"}),e.jsx(i,{children:"VGA"}),e.jsx(i,{children:"Webcam"}),e.jsx(i,{children:"Trạng thái"})]})}),e.jsx(oe,{children:(t=O[a])==null?void 0:t.map(r=>{var s;return e.jsxs(y,{children:[e.jsx(i,{children:e.jsx(le,{checked:((s=H[a])==null?void 0:s.includes(r.id))||!1,onChange:()=>be(a,r),disabled:h})}),e.jsx(i,{children:r.giaBan}),e.jsx(i,{children:r.banPhim}),e.jsx(i,{children:r.cpu}),e.jsx(i,{children:r.heDieuHanh}),e.jsx(i,{children:r.manHinh}),e.jsx(i,{children:r.mauSac}),e.jsx(i,{children:r.ram}),e.jsx(i,{children:r.vga}),e.jsx(i,{children:r.webcam}),e.jsxs(i,{children:[" ",e.jsx(j,{sx:{display:"inline-block",padding:"4px 8px",borderRadius:"8px",backgroundColor:r.trangThai===0?"error.light":"success.light",color:r.trangThai===0?"error.dark":"success.dark",fontWeight:"bold"},children:r.trangThai===0?"Không hoạt động":"Hoạt động"})]})]},r.id)})})]})})},a)})]}),e.jsx(Me,{open:T.open,autoHideDuration:6e3,onClose:Z,anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(_e,{onClose:Z,severity:T.severity,sx:{width:"100%"},children:T.message})}),e.jsxs(Xe,{open:pe,onClose:()=>$(!1),children:[e.jsx(Je,{children:"Xác nhận"}),e.jsx(Qe,{children:e.jsx(Ze,{children:"Bạn có chắc chắn muốn lưu thông tin phiếu giảm giá này?"})}),e.jsxs(Ue,{children:[e.jsx(E,{onClick:()=>$(!1),color:"primary",children:"Hủy"}),e.jsx(E,{onClick:()=>$(!0),color:"primary",autoFocus:!0,children:"Xác nhận"})]})]})]})}export{xa as default};

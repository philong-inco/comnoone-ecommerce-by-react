import{r as o,aa as Pe,a4 as we,b5 as $e,ab as j,j as e,G as O,V as v,N as g,z as I,I as ee,T as N,Z as L,ac as Be,J as Ae,a6 as Ee,a7 as ae,a8 as te,B as y,a9 as Oe}from"./index-ODiMIL8c.js";import{B as f,d as Le,a as Fe,b as We}from"./ArrowBack-C8LCQV1B.js";import{c as qe,a as F,d as ie}from"./index.esm-gNzFFELg.js";import{u as He}from"./formik.esm-mdqt1M28.js";import{g as Re,b as re}from"./dotGiamGiaService-CaQ0kiSX.js";import{T as ne,a as se,b as oe,c as b,d as le}from"./TableRow-CiYyoDmn.js";import{T as n}from"./TableCell-CvT0UNUt.js";import{C as ce}from"./Checkbox-CZLLfLAq.js";import{P as ze}from"./Pagination-BfakT0Tw.js";import{T as Ke,a as Me}from"./Tabs-BadM-OuN.js";import{S as Ve,A as _e}from"./Snackbar-cwqFnrZx.js";import{a as Xe,c as Je,b as Qe,D as Ue}from"./DialogTitle-UPTmzQrS.js";import{D as Ze}from"./DialogContentText-C6_zaY_q.js";import"./LastPage-BI26Cmhz.js";import"./KeyboardArrowRight-DRQYp2Cc.js";import"./Close-BVp8FVaf.js";function xa(){const[W,q]=o.useState({}),[P,H]=o.useState([]),[p,R]=o.useState([]),[z,K]=o.useState({}),[he,M]=o.useState(!1),[V,de]=o.useState(0),{id:T}=Pe(),_=we(),X=$e(),[S,m]=o.useState({open:!1,message:"",severity:"success"}),[Ye,w]=o.useState(!1),[d,J]=o.useState(!1),[u,$]=o.useState("%"),[C,ue]=o.useState(1),[ge,pe]=o.useState(1),[B,Ie]=o.useState(5),[me,Q]=o.useState(!1);o.useEffect(()=>{U(C,B)},[C,B]),o.useEffect(()=>{X.pathname.includes("/dotgiamgia/cauhinhdotgiamgia/view")?J(!0):J(!1)},[X,T]),o.useEffect(()=>{const a=async()=>{debugger;try{const t=await Promise.all(p.map(async i=>{const s=await re(i);return{sanPhamId:i,productDetails:s.data.data}}));q(i=>{const s={...i};return t.forEach(({sanPhamId:l,productDetails:x})=>{s[l]=x}),s})}catch{m({open:!0,message:"không thể tìm được sản phẩm chi tiết",severity:"error"})}};p.length>0&&a()},[p]),o.useEffect(()=>{Ce(),U(C,B)},[T]);const U=async(a,t)=>{M(!0);try{const i=await Re(a-1,t);H(i.data||[]),pe(i.totalPage||1)}catch(i){console.error("Lỗi khi tải dữ liệu sản phẩm:",i),m({open:!0,message:"Lỗi khi tải dữ liệu sản phẩm",severity:"error"})}finally{M(!1)}},xe=(a,t)=>{ue(t)},fe=()=>{_("/dotgiamgia/danhsachdotgiamgia")},Te=async a=>{debugger;R(t=>{const i=t.includes(a)?t.filter(s=>s!==a):[...t,a];return W[a]||(async()=>{try{const l=(await re(a)).data.data;q(x=>({...x,[a]:l}))}catch{m({open:!0,message:"Lỗi khi tải sản phẩm chi tiết",severity:"error"})}})(),i})},je=(a,t)=>{debugger;K(i=>{const s=i[a]||[];return s.includes(t.id)?{...i,[a]:s.filter(l=>l!==t.id)}:{...i,[a]:[...s,t.id]}})},ye=(a,t)=>{de(t)};function Z(a){return a?a.length===16?`${a}:00`:(a.length===19,a):""}const r=He({initialValues:{tenPhieu:"",giaTri:"",giaTriToiDa:"",tuNgay:"",denNgay:"",loaiChietKhau:"1"},validationSchema:qe({tenPhieu:F().required("Tên đợt giảm giá là bắt buộc"),giaTri:F().required("Giá trị là bắt buộc").test("is-valid-value",(a,t)=>{if(!a)return t.createError({message:"Giá trị là bắt buộc"});const i=new f(a.replace(/\./g,""));if(u==="%"){if(!i.isGreaterThan(0))return t.createError({message:"Giá trị phải lớn hơn 0%"});if(!i.isLessThanOrEqualTo(100))return t.createError({message:"Giá trị không được vượt quá 100%"})}else if(u==="$"){if(!i.isGreaterThan(0))return t.createError({message:"Giá trị phải lớn hơn 0$"})}else return t.createError({message:"Loại phiếu không hợp lệ"});return!0}),giaTriToiDa:F().nullable().test("is-correct-value","Giá trị tối đa không hợp lệ",function(a){const{giaTri:t}=this.parent,i=new f(t.replace(/\./g,"")),s=a?new f(a.replace(/\./g,"")):null;if(u==="$"){if(!s||!s.isEqualTo(i))return this.createError({message:"Giá trị tối đa phải bằng với giá trị giảm giá khi loại chiết khấu là tiền."})}else if(u==="%"&&a!==""&&a!=null)return this.createError({message:"Giá trị tối đa phải là chuỗi rỗng khi loại chiết khấu là phần trăm."});return!0}),tuNgay:ie().required("Ngày bắt đầu là bắt buộc").min(new Date,"Ngày bắt đầu phải từ hiện tại trở đi"),denNgay:ie().required("Ngày kết thúc là bắt buộc").when("tuNgay",(a,t)=>t.min(a,"Ngày kết thúc phải sau ngày bắt đầu"))}),onSubmit:async(a,{setErrors:t,validateForm:i})=>{const s=await i();if(Object.keys(s).length>0){t(s);return}try{w(!0);const l=Object.values(z).flat(),x=new f(String(a.giaTri).replace(/\./g,"")),c=a.giaTriToiDa===""?new f(0):new f(String(a.giaTriToiDa).replace(/\./g,""));if(u==="$"){if(!c.isEqualTo(x)){t({giaTriToiDa:"Giá trị tối đa phải bằng với giá trị giảm giá khi loại chiết khấu là tiền."});return}}else if(u==="%"&&a.giaTriToiDa!==""){t({giaTriToiDa:"Giá trị tối đa phải là chuỗi rỗng khi loại chiết khấu là phần trăm."});return}const h={ten:a.tenPhieu,moTa:a.moTa,giaTriGiam:a.giaTri,giamToiDa:a.giaTriToiDa===""?null:new f(String(a.giaTriToiDa).replace(/\./g,"")).toFixed(),loaiChietKhau:u==="%"?1:2,thoiGianBatDau:Z(a.tuNgay),thoiGianKetThuc:Z(a.denNgay),listSanPhamChiTiet:l};let G;T?(G=await j.put(`http://localhost:8080/api/v1/discounts/update/${T}`,h),m({open:!0,message:"Đợt giảm giá đã được cập nhật thành công!",severity:"success"})):(G=await j.post("http://localhost:8080/api/v1/discounts/add",h),m({open:!0,message:"Đợt giảm giá đã được tạo thành công!",severity:"success"})),setTimeout(()=>{_("/dotgiamgia/danhsachdotgiamgia")},3e3)}catch(l){l.response&&l.response.data&&l.response.data.errors?t(l.response.data.errors):(console.log(l),m({open:!0,message:"Đã xảy ra lỗi!",severity:"error"}))}finally{w(!1)}}}),A=a=>{Q(!1),a&&r.handleSubmit()},Y=()=>{m({...S,open:!1}),w(!1)},be=()=>{Q(!0)};function Se(a){return String(a||"").replace(/\D/g,"").replace(/\B(?=(\d{3})+(?!\d))/g,".")}const Ce=async()=>{try{debugger;const t=(await j.get(`http://localhost:8080/api/v1/discounts/${T}`)).data;r.setValues({stat:t.trangThai,maPhieu:t.ma,tenPhieu:t.ten,moTa:t.moTa,giaTri:t.giaTriGiam,tuNgay:t.thoiGianBatDau,denNgay:t.thoiGianKetthuc,giaTriToiDa:t.giamToiDa}),$(t.loaiChietKhau===1?"%":"$");const i=t.spctDotGiamGias||[],s=await Promise.all(i.map(async c=>(await j.get(`http://localhost:8080/api/san-pham-chi-tiet/get-by-productdetail-id?idProductDetail=${c}`)).data.data)),l=s.map(c=>parseInt(c.sanPhamId)).filter((c,h,G)=>!isNaN(c)&&G.indexOf(c)===h),x=s.reduce((c,h)=>(c[h.sanPhamId]||(c[h.sanPhamId]=[]),c[h.sanPhamId].push(h.id),c),{});R(l),K(x)}catch(a){console.error("Error fetching DGG detail:",a)}},[E,De]=o.useState("0"),ke=a=>{const t=a.target.value.toString().trim();E==="0"?k(i=>({...i,tenSanPham:t,ma:""})):E==="1"&&k(i=>({...i,ma:t,tenSanPham:""}))},Ge=a=>{const t=a.target.value;De(t),t==="0"?k(i=>({...i,tenSanPham:D.ma,ma:""})):t==="1"&&k(i=>({...i,ma:D.tenSanPham,tenSanPham:""}))};o.useState(0);const ve="http://localhost:8080/api/san-pham/find/filter-id?",[D,k]=o.useState({page:0,size:"5",tenSanPham:"",ma:"",trangThai:1});o.useEffect(()=>{Ne()},[D]);const Ne=async()=>{const a=Object.entries(D).filter(([s,l])=>l!=="").map(([s,l])=>`${s}=${l}`).join("&"),t=ve+a,i=await j.get(t);H(i.data.data),setTotalElement(parseInt(i.data.totalElement))};return e.jsxs(O,{container:!0,spacing:2,children:[e.jsx(O,{item:!0,xs:4,children:e.jsx(v,{style:{padding:"16px",height:"100%"},children:e.jsxs("form",{onSubmit:r.handleSubmit,children:[e.jsx(g,{label:"Mã Đợt Giảm Giá",name:"maPhieu",fullWidth:!0,margin:"normal",value:r.values.maPhieu,onChange:r.handleChange,InputProps:{readOnly:!0},InputLabelProps:{shrink:!0}}),e.jsx(g,{label:"Tên Đợt Giảm Giá",name:"tenPhieu",fullWidth:!0,margin:"normal",value:r.values.tenPhieu,onChange:r.handleChange,error:r.touched.tenPhieu&&!!r.errors.tenPhieu,helperText:r.touched.tenPhieu&&r.errors.tenPhieu}),e.jsx(g,{label:"Giá trị phiếu",name:"giaTri",fullWidth:!0,margin:"normal",value:r.values.giaTri,onChange:r.handleChange,error:r.touched.giaTri&&!!r.errors.giaTri,helperText:r.touched.giaTri&&r.errors.giaTri,InputProps:{readOnly:d,endAdornment:e.jsxs(I,{position:"end",children:[e.jsx(ee,{onClick:()=>!d&&$("%"),color:u==="%"?"primary":"default",children:e.jsx(Le,{})}),e.jsx(ee,{onClick:()=>!d&&$("$"),color:u==="$"?"primary":"default",children:e.jsx(Fe,{})})]})}}),e.jsx(g,{label:" Giá trị giảm giá tối đa",name:"giaTriToiDa",fullWidth:!0,margin:"normal",value:Se(r.values.giaTriToiDa),onChange:r.handleChange,error:r.touched.giaTriToiDa&&!!r.errors.giaTriToiDa,helperText:r.touched.giaTriToiDa&&r.errors.giaTriToiDa,InputProps:{readOnly:d,endAdornment:e.jsx(I,{position:"end",children:e.jsx(N,{sx:{color:"orange",fontWeight:"bold"},children:"₫"})})}}),e.jsx(g,{label:"Từ ngày",name:"tuNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:d},value:r.values.tuNgay,onChange:r.handleChange,InputLabelProps:{shrink:!0},error:r.touched.tuNgay&&!!r.errors.tuNgay,helperText:r.touched.tuNgay&&r.errors.tuNgay}),e.jsx(g,{label:"Đến ngày",name:"denNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:d},value:r.values.denNgay,onChange:r.handleChange,InputLabelProps:{shrink:!0},error:r.touched.denNgay&&!!r.errors.denNgay,helperText:r.touched.denNgay&&r.errors.denNgay}),e.jsx(g,{label:"Mô tả đợt giảm giá",name:"moTa",fullWidth:!0,margin:"normal",value:r.values.moTa,InputLabelProps:{shrink:!0},onChange:r.handleChange,error:r.touched.moTa&&!!r.errors.moTa,helperText:r.touched.moTa&&r.errors.moTa,sx:{fontFamily:"Arial, sans-serif"}}),!d&&e.jsx(L,{fullWidth:!0,variant:"contained",sx:{mt:2},onClick:be,children:"Lưu"})]})})}),e.jsxs(O,{item:!0,xs:8,children:[e.jsxs(v,{style:{padding:"16px",height:"100%"},children:[e.jsx(N,{variant:"h6",children:"Danh sách sản phẩm"}),e.jsx(Be,{}),e.jsxs("div",{style:{display:"flex",padding:10,paddingTop:20},children:[e.jsx(g,{sx:{maxHeight:"10px"},color:"secondary",onChange:ke,id:"outlined-basic",label:"Nhập từ khóa",variant:"outlined"}),e.jsx("div",{style:{marginLeft:10,display:"flex",alignItems:"center"},children:e.jsx(Ae,{children:e.jsxs(Ee,{"aria-labelledby":"demo-controlled-radio-buttons-group",name:"controlled-radio-buttons-group",value:E,row:!0,onChange:Ge,children:[e.jsx(ae,{value:"0",control:e.jsx(te,{color:"secondary",size:"small"}),label:"Tên"}),e.jsx(ae,{value:"1",control:e.jsx(te,{color:"secondary",size:"small"}),label:"Mã"})]})})})]}),he?e.jsx(N,{children:"Đang tải dữ liệu..."}):e.jsx(ne,{component:v,style:{marginTop:"16px"},children:e.jsxs(se,{children:[e.jsx(oe,{children:e.jsxs(b,{children:[e.jsx(n,{sx:{textAlign:"center"},children:"Mã sản phẩm"}),e.jsx(n,{sx:{textAlign:"center"},children:"Tên sản phẩm"}),e.jsx(n,{sx:{textAlign:"center"},children:"Trạng Thái"}),e.jsx(n,{sx:{textAlign:"center"},children:"Chọn"})]})}),e.jsx(le,{children:P.length>0?P.map(a=>e.jsxs(b,{children:[e.jsx(n,{sx:{textAlign:"center"},children:a.ma}),e.jsx(n,{sx:{textAlign:"center"},children:a.ten}),e.jsx(n,{sx:{textAlign:"center"},children:e.jsx(y,{sx:{backgroundColor:a.trangThai===1?"#4caf50":"#f44336",color:"#ffffff",padding:"6px 12px",borderRadius:"12px",textAlign:"center",fontWeight:"bold"},children:a.trangThai===1?"Hoạt động":"Đã tắt"})}),e.jsx(n,{sx:{textAlign:"center"},children:e.jsx(ce,{checked:p.includes(a.id),onChange:()=>Te(a.id),disabled:d})})]},a.id)):e.jsx(b,{children:e.jsx(n,{colSpan:4,children:e.jsx(N,{variant:"body2",color:"textSecondary",align:"center",children:"Không có sản phẩm nào"})})})})]})}),e.jsx(y,{display:"fixed",justifyContent:"center",alignItems:"center",marginTop:2,children:e.jsx(ze,{count:ge,page:C,onChange:xe,color:"primary"})})]}),e.jsxs(Oe,{color:"primary","aria-label":"back",sx:{position:"fixed",bottom:16,right:16},onClick:fe,children:[e.jsx(We,{}),"  "]})]}),e.jsxs(y,{sx:{marginTop:4},children:[e.jsx(Ke,{value:V,onChange:ye,children:p.map(a=>{const t=P.find(i=>i.id===a);return e.jsx(Me,{label:t?`${t.ten}`:`Sản phẩm ${a}`},a)})}),p.map(a=>{var t;return V===p.indexOf(a)&&e.jsx(y,{sx:{marginTop:2},children:e.jsx(ne,{component:v,children:e.jsxs(se,{children:[e.jsx(oe,{children:e.jsxs(b,{children:[e.jsx(n,{children:"Chọn"}),e.jsx(n,{children:"Giá bán"}),e.jsx(n,{children:"Bàn phím"}),e.jsx(n,{children:"CPU"}),e.jsx(n,{children:"Hệ điều hành"}),e.jsx(n,{children:"Màn hình"}),e.jsx(n,{children:"Màu sắc"}),e.jsx(n,{children:"RAM"}),e.jsx(n,{children:"VGA"}),e.jsx(n,{children:"Webcam"}),e.jsx(n,{children:"Trạng thái"})]})}),e.jsx(le,{children:(t=W[a])==null?void 0:t.map(i=>{var s;return e.jsxs(b,{children:[e.jsx(n,{children:e.jsx(ce,{checked:((s=z[a])==null?void 0:s.includes(i.id))||!1,onChange:()=>je(a,i),disabled:d})}),e.jsx(n,{children:i.giaBan}),e.jsx(n,{children:i.banPhim}),e.jsx(n,{children:i.cpu}),e.jsx(n,{children:i.heDieuHanh}),e.jsx(n,{children:i.manHinh}),e.jsx(n,{children:i.mauSac}),e.jsx(n,{children:i.ram}),e.jsx(n,{children:i.vga}),e.jsx(n,{children:i.webcam}),e.jsxs(n,{children:[" ",e.jsx(y,{sx:{display:"inline-block",padding:"4px 8px",borderRadius:"8px",backgroundColor:i.trangThai===0?"error.light":"success.light",color:i.trangThai===0?"error.dark":"success.dark",fontWeight:"bold"},children:i.trangThai===0?"Không hoạt động":"Hoạt động"})]})]},i.id)})})]})})},a)})]}),e.jsx(Ve,{open:S.open,autoHideDuration:6e3,onClose:Y,anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(_e,{onClose:Y,severity:S.severity,sx:{width:"100%"},children:S.message})}),e.jsxs(Xe,{open:me,onClose:()=>A(!1),children:[e.jsx(Je,{children:"Xác nhận"}),e.jsx(Qe,{children:e.jsx(Ze,{children:"Bạn có chắc chắn muốn lưu thông tin phiếu giảm giá này?"})}),e.jsxs(Ue,{children:[e.jsx(L,{onClick:()=>A(!1),color:"primary",children:"Hủy"}),e.jsx(L,{onClick:()=>A(!0),color:"primary",autoFocus:!0,children:"Xác nhận"})]})]})]})}export{xa as default};

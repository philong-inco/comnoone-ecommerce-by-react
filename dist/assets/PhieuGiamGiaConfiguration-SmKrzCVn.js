import{r as t,aa as Pe,a4 as ve,ab as F,j as e,G as i,V as Z,T as K,a2 as m,N as c,z as Q,I as U,a5 as N,a6 as De,a7 as Y,a8 as ee,Z as H,B as ae,J as ne,ac as Ge,ad as Fe,a9 as Ke}from"./index-r6x2ypbK.js";import{B as u,d as Ne,a as He,b as Le}from"./ArrowBack-B_okQd0w.js";import{c as we,a as L,b as Be,d as re,e as Ie}from"./index.esm-dzP1O6C2.js";import{u as We}from"./formik.esm-wKSNXZp7.js";import{g as Ae,a as $e,b as ie}from"./customerService-CXAsWmbH.js";import{M as y}from"./MenuItem-Cpk-906f.js";import{T as Ee,a as Ve,b as Oe,c as te,d as qe}from"./TableRow-CTax1pli.js";import{T as h}from"./TableCell-7vhPCx5T.js";import{C as oe}from"./Checkbox-BbnBiFg8.js";import{P as Re}from"./Pagination-DzifC26g.js";import{S as Me,A as ze}from"./Snackbar-Dh6eEEaa.js";import{a as _e,c as Xe,b as Je,D as Ze}from"./DialogTitle-BvLtCuRU.js";import{D as Qe}from"./DialogContentText-BFvDpVta.js";import"./request-DnaihQv_.js";import"./LastPage-DUSx3Tck.js";import"./Close-C-vCMd3Z.js";function pa(){const[g,w]=t.useState("%"),[S,B]=t.useState([]),[o,j]=t.useState([]),[p,I]=t.useState(1),[se,le]=t.useState(0),[Ue,W]=t.useState(!1),{id:b}=Pe(),A=ve();t.useState(null);const[T,d]=t.useState({open:!1,message:"",severity:"success"}),[he,$]=t.useState(!1),[P,ce]=t.useState(!1),[x,E]=t.useState(""),[f,ue]=t.useState(""),[ge,v]=t.useState(!1),de=we({tenPhieu:L().required("Tên phiếu giảm giá là bắt buộc"),giaTri:L().required("Giá trị là bắt buộc").test("is-valid-value",(a,r)=>{if(!a)return r.createError({message:"Giá trị là bắt buộc"});const l=new u(a.replace(/\./g,""));if(g==="%"){if(!l.isGreaterThan(0))return r.createError({message:"Giá trị phải lớn hơn 0%"});if(!l.isLessThanOrEqualTo(100))return r.createError({message:"Giá trị không được vượt quá 100%"})}else if(g==="$"){if(!l.isGreaterThan(0))return r.createError({message:"Giá trị phải lớn hơn 0$"})}else return r.createError({message:"Loại phiếu không hợp lệ"});return!0}),soLuong:Be().required("Số lượng là bắt buộc").positive("Số lượng phải lớn hơn 0").integer("Số lượng phải là số nguyên"),dieuKien:L().required("Điều kiện là bắt buộc").test("is-big-decimal","Điều kiện phải lớn hơn 10",a=>a?new u(a.replace(/\./g,"")).isGreaterThan(10):!1),tuNgay:re().min(new Date,"Từ ngày phải là ngày trong tương lai").required("Từ ngày là bắt buộc"),denNgay:re().min(Ie("tuNgay"),"Đến ngày phải sau từ ngày").required("Đến ngày là bắt buộc")});t.useEffect(()=>{me()},[p,x,f,b]);const me=async()=>{W(!0);try{let a;x&&f==""?a=await Ae(p-1,x):f!==""&&x==""?a=await $e(p-1,f):f==""&&x==""&&(a=await ie(p-1)),B(a.content),le(a.totalPages)}catch(a){console.error(a)}finally{W(!1)}};t.useEffect(()=>{pe(),Ce()},[b]);const pe=async()=>{try{const a=await ie(p-1);B(a.content)}catch(a){console.error(a)}},xe=a=>{const r={width:"100px",textAlign:"center"};switch(a){case 0:return e.jsx(m,{label:"Đồng",color:"default",sx:{...r,backgroundColor:"#CD853F",color:"#FFFFFF"}});case 1:return e.jsx(m,{label:"Bạc",color:"default",sx:{...r,backgroundColor:"#C0C0C0",color:"#000000"}});case 2:return e.jsx(m,{label:"Vàng",color:"default",sx:{...r,backgroundColor:"#FFD700",color:"#000000"}});case 3:return e.jsx(m,{label:"Bạch Kim",color:"default",sx:{...r,backgroundColor:"#E5E4E2",color:"#000000"}});case 4:return e.jsx(m,{label:"Kim Cương",color:"default",sx:{...r,backgroundColor:"#363636",color:"#FFFFFF"}});default:return e.jsx(m,{label:"Không xác định",color:"default",sx:{...r,backgroundColor:"#FFFFFF",color:"#000000"}})}},fe=a=>{const r=a.target.value;ue(r),I(1),E("")},ye=()=>{A("/phieugiamgia/danhsachphieugiamgia")};t.useEffect(()=>{console.log("Danh sách khách hàng đã chọn:",o)},[]),t.useEffect(()=>{o.length>n.values.soLuong&&(n.setFieldValue("soLuong",o.length),d({open:!0,message:`Số lượng khách hàng đã chọn (${o.length}) nhiều hơn số lượng phiếu đã nhập, số lượng phiếu đã được tự động điều chỉnh.`,severity:"info"}))},[o]);const n=We({initialValues:{tenPhieu:"",giaTri:"",giaTriToiDa:"",soLuong:"",dieuKien:"",tuNgay:"",denNgay:"",kieu:"1"},validationSchema:de,onSubmit:async(a,{setErrors:r,validateForm:l})=>{var z,_;const C=await l();if(Object.keys(C).length>0){r(C);return}try{if(v(!0),a.kieu==="2"&&o.length>a.soLuong){d({open:!0,message:`Số lượng khách hàng được chọn (${o.length}) nhiều hơn số lượng phiếu (${a.soLuong}). Vui lòng tăng số lượng phiếu.`,severity:"error"});return}if(a.kieu==="2"&&o.length<1){d({open:!0,message:"Vui lòng chọn khách hàng cho phiếu giảm giá.",severity:"error"});return}const G=new u(String(a.giaTri).replace(/\./g,"")),X=a.giaTriToiDa===""?new u(0):new u(String(a.giaTriToiDa).replace(/\./g,""));if(g==="$"){if(!X.isEqualTo(G)){r({giaTriToiDa:"Giá trị tối đa phải bằng với giá trị giảm giá khi loại chiết khấu là tiền."});return}}else if(g==="%"&&a.giaTriToiDa!==""){r({giaTriToiDa:"Giá trị tối đa phải là chuỗi rỗng khi loại chiết khấu là phần trăm."});return}const k={ten:a.tenPhieu,giaTriDonToiThieu:new u(String(a.dieuKien).replace(/\./g,"")).toFixed(),ngayBatDau:q(a.tuNgay),ngayHetHan:q(a.denNgay),loaiGiamGia:g==="%"?1:2,giaTriGiamGia:new u(String(a.giaTri).replace(/\./g,"")).toFixed(),giamToiDa:a.giaTriToiDa===""?null:new u(String(a.giaTriToiDa).replace(/\./g,"")).toFixed(),phamViApDung:a.kieu,soLuong:a.soLuong,listKhachHang:o};let J;b?(J=await F.put(`http://localhost:8080/api/coupons/update/${b}`,k),d({open:!0,message:"Phiếu giảm giá đã được cập nhật thành công!",severity:"success"})):(J=await F.post("http://localhost:8080/api/coupons/add",k),d({open:!0,message:"Phiếu giảm giá đã được tạo thành công!",severity:"success"})),setTimeout(()=>{A("/phieugiamgia/danhsachphieugiamgia")},3e3)}catch(G){const k=(((_=(z=G.response)==null?void 0:z.data)==null?void 0:_.error)||"Đã xảy ra lỗi!").split(":")[1].split(":")[0].trim();d({open:!0,message:`Lỗi: ${k}`,severity:"error"})}finally{v(!1)}}}),V=a=>{w(a)},be=a=>{j(r=>{const l=Array.isArray(r)&&r.includes(a)?r.filter(C=>C!==a):[...Array.isArray(r)?r:[],a];return console.log("Selected KhachHang within handler:",l),l})},O=a=>[{id:0,name:"Chưa áp dụng",color:"gray"},{id:1,name:"Đang áp dụng",color:"green"},{id:2,name:"Đã hết hạn",color:"red"},{id:3,name:"Đã hủy",color:"orange"}].find(l=>l.id===a)||{name:"Không xác định",color:"default"},je=(a,r)=>{I(r)},Te=a=>{const r={year:"numeric",month:"2-digit",day:"2-digit"};return new Date(a).toLocaleDateString("vi-VN",r)};function q(a){return a?a.length===16?`${a}:00`:(a.length===19,a):""}const R=()=>{d({...T,open:!1}),v(!1)},Ce=async()=>{try{const r=(await F.get(`http://localhost:8080/api/coupons/detail/${b}`)).data;n.setValues({stat:r.data.trangThai,maPhieu:r.data.ma,tenPhieu:r.data.ten,giaTri:r.data.giaTriGiamGia,giaTriToiDa:r.data.giamToiDa,soLuong:r.data.soLuong,dieuKien:r.data.giaTriDonToiThieu,tuNgay:r.data.ngayBatDau,denNgay:r.data.ngayHetHan,kieu:r.data.phamViApDung.toString()}),w(r.data.loaiGiamGia===1?"%":"$");const l=r.data.khachHangPhieuGiamGias||[];j(l)}catch(a){console.error("Error fetching coupon detail:",a)}},s=location.pathname.includes("/phieugiamgia/chitietphieugiamgia"),ke=()=>{$(!0)},D=a=>{$(!1),a&&n.handleSubmit()};function M(a){return String(a||"").replace(/\D/g,"").replace(/\B(?=(\d{3})+(?!\d))/g,".")}const Se=()=>{j(P?[]:S.map(a=>a.id)),ce(!P)};return e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:6,children:e.jsxs(Z,{style:{padding:"16px",height:"100%"},children:[s&&e.jsxs(i,{item:!0,xs:12,sx:{mb:2},children:[e.jsx(K,{variant:"h6",children:"Trạng thái phiếu:"}),e.jsx(m,{label:O(n.values.stat).name,sx:{backgroundColor:O(n.values.stat).color,color:"white",fontWeight:"bold"}})]}),e.jsxs("form",{onSubmit:n.handleSubmit,children:[e.jsx(c,{label:"Mã Phiếu Giảm Giá",name:"maPhieu",fullWidth:!0,margin:"normal",value:n.values.maPhieu,onChange:n.handleChange,error:n.touched.maPhieu&&!!n.errors.maPhieu,helperText:n.touched.maPhieu&&n.errors.maPhieu,InputProps:{readOnly:!0},InputLabelProps:{shrink:!0}}),e.jsx(c,{label:"Tên Phiếu Giảm Giá",name:"tenPhieu",fullWidth:!0,margin:"normal",InputProps:{readOnly:s},value:n.values.tenPhieu,onChange:n.handleChange,error:n.touched.tenPhieu&&!!n.errors.tenPhieu,helperText:n.touched.tenPhieu&&n.errors.tenPhieu}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:6,children:e.jsx(c,{label:"Giá trị giảm giá",name:"giaTri",fullWidth:!0,margin:"normal",value:n.values.giaTri,onChange:n.handleChange,error:n.touched.giaTri&&!!n.errors.giaTri,helperText:n.touched.giaTri&&n.errors.giaTri,InputProps:{readOnly:s,endAdornment:e.jsxs(Q,{position:"end",children:[e.jsx(U,{onClick:()=>{s||V("%")},color:g==="%"?"primary":"default",children:e.jsx(Ne,{})}),e.jsx(U,{onClick:()=>{s||V("$")},color:g==="$"?"primary":"default",children:e.jsx(He,{})})]})}})}),e.jsx(i,{item:!0,xs:6,children:e.jsx(c,{label:" Giá trị giảm giá tối đa",name:"giaTriToiDa",fullWidth:!0,margin:"normal",value:M(n.values.giaTriToiDa),onChange:n.handleChange,error:n.touched.giaTriToiDa&&!!n.errors.giaTriToiDa,helperText:n.touched.giaTriToiDa&&n.errors.giaTriToiDa,InputProps:{readOnly:s,endAdornment:e.jsx(Q,{position:"end",children:e.jsx(K,{sx:{color:"orange",fontWeight:"bold"},children:"₫"})})}})})]}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:6,children:e.jsx(c,{label:"Số lượng",value:n.values.soLuong,onChange:n.handleChange,variant:"outlined",fullWidth:!0,margin:"normal",name:"soLuong",helperText:n.touched.soLuong&&n.errors.soLuong?n.errors.soLuong:"",error:n.touched.soLuong&&!!n.errors.soLuong})}),e.jsx(i,{item:!0,xs:6,children:e.jsx(c,{label:"Giá trị đơn tối thiểu",name:"dieuKien",fullWidth:!0,margin:"normal",InputProps:{readOnly:s},value:M(n.values.dieuKien),onChange:n.handleChange,error:n.touched.dieuKien&&!!n.errors.dieuKien,helperText:n.touched.dieuKien&&n.errors.dieuKien})})]}),e.jsxs(i,{container:!0,spacing:2,children:[e.jsx(i,{item:!0,xs:6,children:e.jsx(c,{label:"Từ ngày",name:"tuNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:s},value:n.values.tuNgay,onChange:n.handleChange,InputLabelProps:{shrink:!0},error:n.touched.tuNgay&&!!n.errors.tuNgay,helperText:n.touched.tuNgay&&n.errors.tuNgay})}),e.jsx(i,{item:!0,xs:6,children:e.jsx(c,{label:"Đến ngày",name:"denNgay",type:"datetime-local",fullWidth:!0,margin:"normal",InputProps:{readOnly:s},value:n.values.denNgay,InputLabelProps:{shrink:!0},onChange:n.handleChange,error:n.touched.denNgay&&!!n.errors.denNgay,helperText:n.touched.denNgay&&n.errors.denNgay})})]}),e.jsxs(i,{container:!0,justifyContent:"flex-start",alignItems:"center",spacing:2,children:[e.jsx(i,{item:!0,children:e.jsx(N,{component:"legend",children:"Phạm vi áp dụng"})}),e.jsx(i,{item:!0,children:e.jsxs(De,{row:!0,"aria-label":"phạm vi áp dụng",name:"kieu",value:n.values.kieu,onChange:a=>{s||n.handleChange(a)},children:[e.jsx(Y,{value:"1",control:e.jsx(ee,{}),label:"Công khai"}),e.jsx(Y,{value:"2",control:e.jsx(ee,{}),label:"Cá nhân hóa"})]})})]}),!s&&e.jsx(H,{fullWidth:!0,variant:"contained",sx:{mt:2},onClick:ke,disabled:ge,children:"Lưu"})]})]})}),e.jsx(i,{item:!0,xs:6,children:e.jsxs(Z,{style:{padding:"16px",height:"100%"},children:[e.jsx(K,{variant:"h6",gutterBottom:!0,children:"Chọn khách hàng"}),e.jsx(ae,{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between",mb:2,p:2,sx:{backgroundColor:"white",boxShadow:"0 4px 8px rgba(0, 0, 0, 0.1)",borderRadius:"8px",width:"100%"},children:e.jsxs(i,{container:!0,spacing:2,alignItems:"center",children:[e.jsx(i,{item:!0,xs:5,children:e.jsxs(ne,{fullWidth:!0,children:[e.jsx(N,{component:"legend",sx:{mb:1,fontWeight:"bold",fontSize:"1rem",color:"text.primary"},children:"Tìm kiếm"}),e.jsx(c,{value:x,onChange:a=>E(a.target.value),variant:"outlined",placeholder:"Nhập tên khách hàng",fullWidth:!0,InputProps:{style:{borderRadius:"8px"}}})]})}),e.jsx(Ge,{orientation:"vertical",flexItem:!0,sx:{mx:2}}),e.jsx(i,{item:!0,xs:5,children:e.jsxs(ne,{fullWidth:!0,children:[e.jsx(N,{component:"legend",sx:{mb:1,fontWeight:"bold",fontSize:"1rem",color:"text.primary"},children:"Hạng khách hàng"}),e.jsxs(Fe,{labelId:"hang-khach-hang-label",id:"hang-khach-hang-select",value:f,onChange:fe,displayEmpty:!0,fullWidth:!0,sx:{borderRadius:"8px",backgroundColor:"white"},children:[e.jsx(y,{value:"",children:"-- Tất cả khách hàng --"}),e.jsx(y,{value:0,children:"Đồng"}),e.jsx(y,{value:1,children:"Bạc"}),e.jsx(y,{value:2,children:"Vàng"}),e.jsx(y,{value:3,children:"Bạch Kim"}),e.jsx(y,{value:4,children:"Kim Cương"})]})]})}),e.jsx(Ke,{color:"primary","aria-label":"back",sx:{position:"fixed",bottom:16,right:16},onClick:ye,children:e.jsx(Le,{})})]})}),e.jsx(Ee,{children:e.jsxs(Ve,{children:[e.jsx(Oe,{children:e.jsxs(te,{children:[e.jsx(h,{padding:"checkbox",children:e.jsx(oe,{indeterminate:o.length>0&&o.length<S.length,checked:P,onChange:Se,disabled:s||n.values.kieu==="1"})}),e.jsx(h,{children:"Tên khách hàng"}),e.jsx(h,{children:"Số điện thoại"}),e.jsx(h,{children:"Ngày sinh"}),e.jsx(h,{children:"Hạng khách hàng"})]})}),e.jsx(qe,{children:S.map(a=>e.jsxs(te,{children:[e.jsx(h,{padding:"checkbox",children:e.jsx(oe,{checked:Array.isArray(o)&&o.includes(a.id),onChange:()=>be(a.id),disabled:s||n.values.kieu==="1"})}),e.jsx(h,{children:a.ten}),e.jsx(h,{children:a.sdt}),e.jsx(h,{children:Te(a.ngaySinh)}),e.jsx(h,{children:xe(a.hangKhachHang)})]},a.id))})]})}),e.jsx(ae,{display:"fixed",justifyContent:"center",alignItems:"center",marginTop:2,children:e.jsx(Re,{count:se,page:p,onChange:je,color:"primary"})})]})}),e.jsx(Me,{open:T.open,autoHideDuration:6e3,onClose:R,anchorOrigin:{vertical:"top",horizontal:"center"},children:e.jsx(ze,{onClose:R,severity:T.severity,sx:{width:"100%"},children:T.message})}),e.jsxs(_e,{open:he,onClose:()=>D(!1),children:[e.jsx(Xe,{children:"Xác nhận"}),e.jsx(Je,{children:e.jsx(Qe,{children:"Bạn có chắc chắn muốn lưu thông tin phiếu giảm giá này?"})}),e.jsxs(Ze,{children:[e.jsx(H,{onClick:()=>D(!1),color:"primary",children:"Hủy"}),e.jsx(H,{onClick:()=>D(!0),color:"primary",autoFocus:!0,children:"Xác nhận"})]})]})]})}export{pa as default};
